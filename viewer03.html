<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Viewer Gaz ‚Äì Export local</title>

<!-- Librairies -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body{
        font-family: Arial, sans-serif;
        padding:20px;
        background:#f8f8f8;
    }

    h2{
        margin-top:0;
    }

    #selectors{
        display:flex;
        gap:40px;
        margin-bottom:20px;
    }

    label{
        display:block;
        margin-bottom:4px;
    }

    #chartBox{
        background:#fff;
        padding:15px;
        border-radius:6px;
    }

    .warn{
        padding:20px;
        background:#ffe6e6;
        border:1px solid #d66;
        color:#900;
        border-radius:6px;
    }
</style>
</head>
<body>

<h2>üìä Courbes Export Gaz</h2>
<div id="status"></div>

<div id="selectors" style="display:none;">
    <div>
        <b>Axe X</b>
        <select id="xColumn"></select>
    </div>
    <div>
        <b>Axes Y</b>
        <div id="yColumns"></div>
    </div>
</div>

<div id="chartBox" style="display:none;">
    <canvas id="chart" height="130"></canvas>
</div>

<script>
(function(){

    /* üü¢ 1. R√©cup√©rer CSV brut depuis exportGazCsvData */
    const raw = localStorage.getItem("exportGazCsvData");
    if(!raw){
        document.getElementById("status").innerHTML =
            "<div class='warn'><b>‚ö†Ô∏è Aucun CSV trouv√©.</b><br>Ouvre ce viewer via le bouton Export Gaz.</div>";
        return;
    }
    localStorage.removeItem("exportGazCsvData");

    /* üü¢ 2. Parser CSV */
    const parsed = Papa.parse(raw,{
        header:true,
        dynamicTyping:true,
        skipEmptyLines:true
    });

    const data = parsed.data;
    const headers = parsed.meta.fields;

    if(!data.length){
        document.getElementById("status").innerHTML =
            "<div class='warn'>CSV vide.</div>";
        return;
    }

    /* üü¢ 3. Construire UI colonnes */
    const xSel = document.getElementById("xColumn");
    const yContainer = document.getElementById("yColumns");

    headers.forEach(h=>{
        // X
        const opt = document.createElement("option");
        opt.value=h;
        opt.textContent=h;
        xSel.appendChild(opt);

        // Y
        const lbl=document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" value="${h}"> ${h}`;
        yContainer.appendChild(lbl);
    });

    // Choisir une colonne temporelle par d√©faut
    const autoX = headers.find(h=>/date|time|heure/i.test(h)) || headers[0];
    xSel.value = autoX;

    // S√©lectionner tous les champs sauf X
    [...yContainer.querySelectorAll("input")].forEach(cb=>{
        if(cb.value !== autoX) cb.checked = true;
    });

    document.getElementById("selectors").style.display="flex";

    /* üü¢ 4. Render Chart */
    let chart=null;

    function draw(){
        const xField = xSel.value;
        const yFields = [...yContainer.querySelectorAll("input:checked")]
            .map(cb=>cb.value)
            .filter(v=>v !== xField);

        const labels = data.map(r => String(r[xField]));

        const datasets = yFields.map((f,i)=>({
            label: f,
            data: data.map(r => r[f]),
            borderColor:`hsl(${i*48},70%,50%)`,
            borderWidth:2,
            pointRadius:0,
            tension:0.15
        }));

        if(chart) chart.destroy();

        chart = new Chart(
            document.getElementById("chart"),
            {
                type:"line",
                data:{labels,datasets},
                options:{
                    plugins:{legend:{position:"top"}},
                    animation:false,
                    responsive:true,
                    scales:{
                        x:{ticks:{maxRotation:45,minRotation:0}},
                        y:{beginAtZero:false}
                    }
                }
            }
        );

        document.getElementById("chartBox").style.display="block";
    }

    /* üü¢ 5. Events ‚Üí mise √† jour graphique */
    xSel.onchange = draw;
    yContainer.oninput = draw;

    draw();

})();
</script>

</body>
</html>
