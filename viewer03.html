<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Courbes Gaz</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåΩ</text></svg>">

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    :root{
      --bg:#fff5f5; --panel:#ffffff; --accent:#ff7043; --accent-darker:#e64a19;
      --accent-muted:#fff9f7; --danger:#d84315; --text:#333; --shadow:rgba(0,0,0,0.1);
    }

    body{
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      background:var(--bg); margin:0; padding:5px 20px; color:var(--danger);
      display:flex; flex-direction:column; min-height:100vh;
    }

    .header{position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:10px;}
    .header .logo{height:60px;width:auto;}
    #fileNameContainer{position:absolute;right:0;top:0;text-align:right;}
    #fileName,#lineCount{color:var(--accent-darker);}
    #fileName{font-size:24px;font-weight:bold;white-space:nowrap;max-width:300px;overflow:hidden;text-overflow:ellipsis;display:none;}
    #lineCount{font-size:12px;display:none;}

    .controls{
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    button{
      background:var(--accent); color:#fff; border:none; cursor:pointer;
      font-weight:bold; padding:8px 12px; border-radius:6px; font-size:13px;
      transition:background-color .3s, transform .2s;
    }
    button:hover{background:var(--accent-darker);transform:scale(1.05);}
    button:disabled{background:#ccc;color:#666;cursor:not-allowed;transform:none;}
    .controls button{flex:0 0 auto; width:auto; display:inline-block;}

    .graph-wrapper {
      display:flex;
      align-items:stretch;
      justify-content:center;
      gap:20px;
      margin-bottom:40px;
      height:700px;
    }
    .graph-side {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }
    #myChart {
      width:100%;
      aspect-ratio:16/9;
      max-height:700px;
      background:#fff;
      border-radius:8px;
      box-shadow:0 4px 12px var(--shadow);
      display:block;
      margin:0 auto;
    }

    .y-columns {
      display:flex;
      flex-direction:column;
      gap:4px;
      height:auto;
      max-height:700px;
      overflow-y:auto;
      border:1px solid #ddd;
      padding:6px;
      border-radius:6px;
      background:var(--panel);
      scrollbar-width:thin;
      width:220px;
    }
    .y-columns::-webkit-scrollbar{width:6px;}
    .y-columns::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px;}
    .y-columns::-webkit-scrollbar-track{background:#f0f0f0;}
    .y-columns label{
      display:flex; align-items:center; gap:6px; padding:4px 6px; border-radius:4px; cursor:pointer;
      font-size:13px; background:var(--accent-muted); user-select:none; white-space:nowrap; justify-content:flex-start;
    }
    .y-columns input[type="checkbox"]{accent-color:var(--accent);}

    #columnSelectors{align-items:center;}

    #extendPrev,#extendNext,#panPrev,#panNext{display:none !important;}

    #currentFolderName {
      position:absolute;
      left:10px;
      top:10px;
      font-size:22px;
      font-weight:bold;
      color:var(--accent);
      white-space:nowrap;
      max-width:500px;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #zoomInfo{
      position:absolute; top:80px; right:20px; background:rgba(255,255,255,0.9);
      border:1px solid var(--accent); border-radius:6px; padding:6px 10px; font-size:12px;
      color:var(--accent-darker); font-weight:bold; z-index:10; pointer-events:none;
    }
    #spinner {
      display:none;
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      z-index:2000;
    }
    .spin-inner {
      width:50px;
      height:50px;
      border:6px solid #ccc;
      border-top:6px solid var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

    #errorBox{
      display:none;position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);
      background:var(--accent-muted);padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);
      z-index:2001;text-align:center;color:var(--danger);font-weight:bold;
    }

    #secretBtn{position:fixed;bottom:10px;right:10px;width:25px;height:25px;opacity:0;cursor:pointer;z-index:2000;}
    #themeMenu{
      display:none;position:fixed;bottom:50px;right:10px;background:var(--panel);
      border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
      padding:10px;z-index:2001;min-width:150px;
    }
    #themeMenu h3{margin:0 0 8px 0;font-size:14px;color:var(--accent);}
    #themeMenu .closeMenu{position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
    #themeMenu .closeMenu:hover{color:var(--accent-darker);}
    #themeMenu button{display:block; width:100%; margin:4px 0; padding:6px; border:none; border-radius:6px;
      background:var(--accent); color:#fff; cursor:pointer; font-size:13px;}
    #themeMenu button:hover{background:var(--accent-darker);}

    @media (max-width:600px){#myChart{width:100%;}}

  </style>
</head>
<body>
  <div class="header">
    <div id="currentFolderName"></div>
    <img src="img/logo.png" alt="Logo" class="logo" />
    <div id="fileNameContainer">
      <div id="fileName"></div>
      <div id="lineCount"></div>
    </div>
  </div>

  <div class="controls">
    <button id="backBtn">‚¨ÖÔ∏è Retour</button>
    <button id="exportPDF" style="display:none;">üìÑ Exporter PDF</button>
    <button id="resetZoom" style="display:none;">üîÑ R√©initialiser zoom</button>
  </div>

  <div class="controls" id="columnSelectors" style="display:none; flex-direction:column; gap:8px;">
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <select id="xColumn"></select>
    </div>
  </div>

  <div class="graph-wrapper">
    <div class="graph-side">
      <div id="yColumnsContainer" class="y-columns"></div>
    </div>
    <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
      <canvas id="myChart" width="1400" height="700"></canvas>
      <input type="color" id="colorPicker" style="display:none;" />
      
    </div>
  </div>

  <div id="zoomInfo">üîç S√©lectionner une zone (drag) pour zoomer, molette+Ctrl pour zoom, Ctrl+clic sur la courbe pour changer sa couleur</div>

  <div id="spinner"><div class="spin-inner"></div></div>

  <div id="errorBox">
    ‚ö†Ô∏è Impossible de charger le fichier Gaz.<br>Relance l'export depuis l'explorateur.<br><br>
    <button onclick="window.location.reload()">R√©essayer</button>
  </div>

  <div id="secretBtn" title=" "></div>
  <div id="themeMenu">
    <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
    <h3>Choisir un th√®me</h3>
    <button onclick="setTheme('orange')">Orange (d√©faut)</button>
    <button onclick="setTheme('blue')">Bleu</button>
    <button onclick="setTheme('green')">Vert</button>
    <button onclick="setTheme('purple')">Violet</button>
    <button onclick="setTheme('bordeaux')">Bordeaux</button>
  </div>

<script>
/* ===================== STATE ===================== */
let csvData = [];
let headers = [];
let chart = null;
let currentX = "";
let currentY = [];
let timeField = "";
let colors = [];
let customColors = {};
let initialMin = null, initialMax = null;
let themeMenuTimer;

/* ===================== THEME ===================== */
function applyThemeVars(vars){
  const r=document.documentElement;
  Object.entries(vars).forEach(([k,v])=>r.style.setProperty(k,v));
  colors = buildPalette();
  if(chart){
    chart.data.datasets.forEach((ds,i)=>{
      const baseLabel = ds.label;
      const saved = customColors[baseLabel];
      const c = saved || colors[i % colors.length];
      ds.borderColor = c;
      ds.backgroundColor = c;
    });
    chart.update('none');
  }
}

function setTheme(theme){
  localStorage.setItem("selectedTheme",theme);

  if(theme==="orange") applyThemeVars({
    "--accent":"#ff7043","--accent-darker":"#e64a19",
    "--accent-muted":"#fff9f7",
    "--bg":"#fff5f5","--panel":"#ffffff",
    "--danger":"#d84315","--text":"#333",
    "--day-bg-strong":"#fff9f7",
    "--day-bg-light":"rgba(0,0,0,0.01)"
  });

  if(theme==="blue") applyThemeVars({
    "--accent":"#2196f3","--accent-darker":"#1976d2",
    "--accent-muted":"#e3f1fc",
    "--bg":"#e3f2fd","--panel":"#ffffff",
    "--danger":"#0d47a1","--text":"#0d47a1",
    "--day-bg-strong":"#bbdefb",
    "--day-bg-light":"rgba(0,0,60,0.02)"
  });

  if(theme==="green") applyThemeVars({
    "--accent":"#4caf50","--accent-darker":"#2e7d32",
    "--accent-muted":"#c8e6c9",
    "--bg":"#f1f8e9","--panel":"#ffffff",
    "--danger":"#1b5e20","--text":"#1b5e20",
    "--day-bg-strong":"#c8e6c9",
    "--day-bg-light":"rgba(0,70,0,0.02)"
  });

  if(theme==="purple") applyThemeVars({
    "--accent":"#9c27b0","--accent-darker":"#6a1b9a",
    "--accent-muted":"#e1bee7",
    "--bg":"#f3e5f5","--panel":"#ffffff",
    "--danger":"#4a148c","--text":"#4a148c",
    "--day-bg-strong":"#e1bee7",
    "--day-bg-light":"rgba(80,0,80,0.02)"
  });

  if(theme==="bordeaux") applyThemeVars({
    "--accent":"#800020","--accent-darker":"#4b0014",
    "--accent-muted":"#d7a1a9",
    "--bg":"#fff0f2","--panel":"#ffffff",
    "--danger":"#600018","--text":"#4b0014",
    "--day-bg-strong":"#d7a1a9",
    "--day-bg-light":"rgba(40,0,0,0.02)"
  });
}

/* Menu secret */
document.getElementById("secretBtn").onclick=()=>{
  const m=document.getElementById("themeMenu");
  m.style.display = (m.style.display==="block") ? "none" : "block";
};
function closeThemeMenu(){document.getElementById("themeMenu").style.display="none";}
function getCSSVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function hexToRgb(hex){hex=hex.replace('#','');const n=parseInt(hex,16);return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
function buildPalette(){return [getCSSVar('--accent'),getCSSVar('--danger'),"#3380ff","#4caf50","#8e44ad","#ff33a6","#33cccc","#ffc300"];}

/* ===================== ERRORS ===================== */
function showError(msg){
  hideSpinner();
  const box = document.getElementById('errorBox');
  if(msg) box.firstChild.textContent = msg;
  box.style.display='block';
}

/* ===================== UTILS ===================== */
function getParam(n){return new URLSearchParams(window.location.search).get(n);}
function dayLabelFR(ts){return new Date(ts).toLocaleDateString('fr-FR');}

/* ===================== DATASETS ===================== */
function buildDatasets(){
  return currentY.map((yCol,i)=>{
    let pts=csvData.map(r=>{
      if(!Number.isFinite(r.__sortKey)) return null;
      return {x:r.__sortKey, y:r[yCol]};
    }).filter(Boolean);

    const label=yCol;
    const saved=customColors[label];
    const c=saved || colors[i % colors.length];

    return {
      label,
      data:pts,
      backgroundColor:c,
      borderColor:c,
      borderWidth:1
    };
  });
}

/* ===================== JOURNAL BACKGROUND ===================== */
const dayBackgroundPlugin={
  id:'dayBackground',
  beforeDraw(chart){
    const {scales:{x},chartArea}=chart;
    if(!x) return;

    const oneDay=86400000;
    let start=new Date(x.min); start.setHours(0,0,0,0);
    let toggle=false;

    const ctx=chart.ctx; ctx.save();
    for(let d=start.getTime(); d<x.max; d+=oneDay){
      const from=x.getPixelForValue(d);
      const to=x.getPixelForValue(d+oneDay);
      ctx.fillStyle = toggle
        ? getCSSVar('--day-bg-strong')
        : getCSSVar('--day-bg-light');
      ctx.fillRect(from,chartArea.top,to-from,chartArea.bottom-chartArea.top);
      toggle=!toggle;
    }
    ctx.restore();
  }
};

/* ===================== CHART ===================== */
function drawChart(){
  if(!csvData.length || !currentY.length) return;

  const ctx=document.getElementById('myChart').getContext('2d');
  const xs=csvData.map(r=>r.__sortKey).filter(Number.isFinite);
  const minX=Math.min(...xs), maxX=Math.max(...xs);

  if(initialMin===null) initialMin=minX;
  if(initialMax===null) initialMax=maxX;

  const dsets=buildDatasets();

  if(chart) chart.destroy();

  chart=new Chart(ctx,{
    type:'bar',
    data:{datasets:dsets},
    options:{
      parsing:false,
      interaction:{mode:'nearest',axis:'x',intersect:true},
      maintainAspectRatio:false,
      plugins:{
        legend:{
          display:true,
          position:'top',
          labels:{color:getCSSVar('--text')}
        },
        zoom:{
          zoom:{wheel:{enabled:true,modifierKey:'ctrl'},drag:{enabled:true,mode:'x'}},
          pan:{enabled:true,mode:'x'}
        }
      },
      scales:{
        x:{
          type:'time',
          min:minX,
          max:maxX,
          time:{unit:'day'}
        }
      }
    },
    plugins:[dayBackgroundPlugin]
  });

  /* üî• ctrl+click ‚Üí change graph color */
  const picker=document.getElementById('colorPicker');
  chart.canvas.addEventListener('click',(ev)=>{
    if(!ev.ctrlKey) return;
    const bars=chart.getElementsAtEventForMode(
      ev,'nearest',{intersect:true},true
    );
    if(!bars.length) return;

    const idx=bars[0].datasetIndex;
    const ds=chart.data.datasets[idx];
    picker.oninput=e=>{
      ds.backgroundColor=e.target.value;
      ds.borderColor=e.target.value;
      customColors[ds.label]=e.target.value;
      chart.update();
    };
    picker.click();
  });
}

/* ===================== INIT ===================== */
(async function init(){
  setTheme(localStorage.getItem("selectedTheme") || "orange");

  const raw=localStorage.getItem("exportGazCsvData");
  if(!raw){showError("‚ö†Ô∏è Pas de CSV Gaz");return;}
  localStorage.removeItem("exportGazCsvData");

  const parsed=Papa.parse(raw,{header:true,dynamicTyping:true,skipEmptyLines:true});
  csvData=parsed.data;
  headers=parsed.meta.fields;

  const xSel=document.getElementById('xColumn');
  const yBox=document.getElementById('yColumnsContainer');

  let defX=headers.find(h=>/date|jour|time/i.test(h.toLowerCase()))||headers[0];

  headers.forEach(h=>{xSel.add(new Option(h,h));});
  headers.forEach(h=>{
    if(h===defX) return;
    const lbl=document.createElement('label');
    lbl.innerHTML=`<input type="checkbox" value="${h}" checked>${h}`;
    yBox.appendChild(lbl);
  });

  timeField=defX;
  csvData.forEach(r=>{
    r.__sortKey=new Date(r[timeField]).getTime();
  });

  currentY=Array.from(
    yBox.querySelectorAll("input:checked")
  ).map(x=>x.value);

  drawChart();
})();
</script>


</body>
</html>
