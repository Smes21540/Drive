<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Viewer Gaz â€“ Histogramme</title>

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#fff5f5;
      --panel:#ffffff;
      --accent:#ff7043;
      --accent-darker:#e64a19;
      --accent-muted:#fff3ed;
      --danger:#d84315;
      --text:#333;
    }
    body{
      margin:0; background:var(--bg);
      font-family:Segoe UI, sans-serif;
      color:var(--text);
    }
    header{
      display:flex; justify-content:center; align-items:center;
      padding:10px;
      position:relative;
    }
    header img{height:55px;}
    #fileName, #lineCount{
      position:absolute; right:10px; top:10px;
      text-align:right;
      color:var(--accent-darker);
    }
    #fileName{font-size:20px; font-weight:bold;}
    #lineCount{font-size:12px;}
    .controls{
      display:flex; justify-content:center; gap:10px;
      margin:10px 0;
    }
    button{
      border:none; background:var(--accent);
      color:white; padding:8px 14px;
      font-size:13px; font-weight:bold;
      border-radius:6px;
      cursor:pointer;
    }
    button:hover{background:var(--accent-darker);}
    .graph-wrapper{
      display:flex; gap:10px; padding:10px;
    }
    .ycols{
      width:230px;
      background:var(--panel);
      padding:8px;
      border-radius:6px;
      overflow-y:auto;
      border:1px solid #ddd;
      max-height:700px;
    }
    .ycols label{
      display:flex; align-items:center; gap:6px;
      margin-bottom:4px;
      background:var(--accent-muted);
      padding:4px;
      border-radius:4px;
      cursor:pointer;
    }
    canvas{
      flex:1;
      background:white;
      box-shadow:0 3px 10px rgba(0,0,0,.1);
      border-radius:6px;
    }
    #zoomInfo{
      text-align:center;
      color:var(--danger);
      font-size:13px;
      padding:6px;
    }
  </style>
</head>

<body>

<header>
  <img src="img/logo.png"/>
  <div id="fileName"></div>
  <div id="lineCount"></div>
</header>

<div class="controls">
  <button id="backBtn">â¬… Retour</button>
  <button id="exportPDF">ðŸ“„ Exporter PDF</button>
  <button id="resetZoom">ðŸ”„ Reset zoom</button>
</div>

<div class="graph-wrapper">
  <div class="ycols" id="yColumns"></div>
  <canvas id="chart" width="1400" height="700"></canvas>
  <input type="color" id="colorPicker" style="display:none;">
</div>

<div id="zoomInfo">Molette + CTRL = zoom | Drag = zoom | CTRL+clic sur une barre pour changer sa couleur</div>


<script>
/* ===========================================================
  VARIABLES
=========================================================== */
let csvData=[];
let headers=[];
let chart=null;
let Yactive=[];
let timeCol="";
let customColors={};
let initMin=null, initMax=null;


/* ===========================================================
  UTILS
=========================================================== */
function getCSS(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function hexToRGB(hex){
  hex=hex.replace('#',''); if(hex.length===3) hex=hex.split('').map(h=>h+h).join('');
  const n=parseInt(hex,16);
  return {r:n>>16&255, g:n>>8&255, b:n&255};
}
function getParam(n){return new URLSearchParams(location.search).get(n);}


/* ===========================================================
  DATASETS
=========================================================== */
function buildDatasets(){
  const palette=[
    getCSS("--accent"),
    getCSS("--danger"),
    "#3380ff","#4caf50",
    "#ff33a6","#8e44ad",
    "#ffc300","#33cccc"
  ];
  return Yactive.map((col,i)=>{
    const c = customColors[col] || palette[i%palette.length];
    const data = csvData
      .map(r=>({x:r.__day,y:r[col]}))
      .filter(v=>Number.isFinite(v.x) && typeof v.y==="number");

    return{
      label:col,
      data,
      backgroundColor:c,
      borderColor:c,
      borderWidth:1,
      barPercentage:0.7,
      categoryPercentage:1
    };
  });
}


/* ===========================================================
  PLUGIN: Alternance par jour
=========================================================== */
const DayPlugin={
  id:"DayPlugin",
  beforeDraw(ch){
    const {scales:{x}, chartArea}=ch;
    if(!x)return;
    const one=86400000;
    const ctx=ch.ctx;

    ctx.save();

    let start=new Date(x.min);
    start.setHours(0,0,0,0);

    let toggle=false;
    for(let d=start.getTime(); d<x.max; d+=one){
      const p1=x.getPixelForValue(d);
      const p2=x.getPixelForValue(d+one);
      const w=p2-p1;
      if(w<=0)continue;

      ctx.fillStyle=toggle?getCSS('--accent-muted'):'rgba(0,0,0,0.03)';
      ctx.fillRect(p1, chartArea.top, w, chartArea.bottom-chartArea.top);

      ctx.beginPath();
      ctx.moveTo(p1,chartArea.top);
      ctx.lineTo(p1,chartArea.bottom);
      ctx.strokeStyle="rgba(0,0,0,0.12)";
      ctx.lineWidth=1;
      ctx.stroke();

      toggle=!toggle;
    }
    ctx.restore();
  }
};


/* ===========================================================
  DRAW CHART
=========================================================== */
function draw(){
  if(chart) chart.destroy();
  if(!csvData.length || !Yactive.length) return;

  const ctx=document.getElementById("chart").getContext("2d");
  const ds=buildDatasets();

  const allX=csvData.map(r=>r.__day).filter(Number.isFinite);
  initMin=Math.min(...allX);
  initMax=Math.max(...allX);

  chart=new Chart(ctx,{
    type:"bar",
    data:{datasets:ds},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      parsing:false,
      interaction:{mode:"nearest",axis:"x",intersect:false},

      plugins:{
        tooltip:{
          enabled:true,
          callbacks:{
            title:(items)=>{
              if(!items.length)return "";
              return new Date(items[0].raw.x).toLocaleDateString("fr-FR");
            },
            label:(i)=>`${i.dataset.label} : ${i.raw.y}`
          }
        },
        legend:{labels:{color:getCSS("--text")}},
        zoom:{
          zoom:{wheel:{enabled:true,modifierKey:"ctrl"},drag:{enabled:true,mode:"x"}},
          pan:{enabled:true,mode:"x"}
        }
      },

      scales:{
        x:{
          type:"time",
          time:{unit:"day",stepSize:1},
          offset:false,
          stacked:true,
          ticks:{
            autoSkip:false,
            callback:(v)=>new Date(v).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})
          }
        },
        y:{
          beginAtZero:true,
          stacked:false,
          title:{display:true,text:"Valeurs"}
        }
      }
    },
    plugins:[DayPlugin]
  });

  const picker=document.getElementById("colorPicker");
  chart.canvas.addEventListener("click",(ev)=>{
    if(!ev.ctrlKey)return;
    const el=chart.getElementsAtEventForMode(ev,"nearest",{intersect:true},true);
    if(!el.length)return;
    const d=chart.data.datasets[el[0].datasetIndex];
    picker.oninput=e=>{
      customColors[d.label]=e.target.value;
      d.backgroundColor=e.target.value;
      d.borderColor=e.target.value;
      chart.update();
    };
    picker.click();
  });
}


/* ===========================================================
  EXPORT PDF HD
=========================================================== */
document.getElementById("exportPDF").onclick=()=>{
  if(!chart) return;

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:"landscape"});
  const W=pdf.internal.pageSize.getWidth();
  const H=pdf.internal.pageSize.getHeight();

  const name=(getParam("fileName")||"ExportGaz.csv").split("\\").pop();
  const title="Consommation Gaz â€” "+name;
  const {r,g,b}=hexToRGB(getCSS("--danger"));

  pdf.setFontSize(16);
  pdf.setTextColor(r,g,b);
  pdf.text(title,10,12);

  const base=chart.canvas;
  const tmp=document.createElement("canvas");
  tmp.width=base.width*3;
  tmp.height=base.height*3;
  const ctx2=tmp.getContext("2d");
  ctx2.fillStyle="#fff";
  ctx2.fillRect(0,0,tmp.width,tmp.height);
  ctx2.scale(3,3);
  ctx2.drawImage(base,0,0);
  const img=tmp.toDataURL("image/jpeg",0.92);

  const maxW=W-20, maxH=H-40;
  const scale=Math.min(maxW/base.width,maxH/base.height);
  const x=(W-base.width*scale)/2;
  const y=20;
  pdf.addImage(img,"JPEG",x,y,base.width*scale,base.height*scale);

  pdf.save(name.replace(/\.csv$/i,".pdf"));
};


/* ===========================================================
  INIT
=========================================================== */
(async()=>{
  const raw=localStorage.getItem("exportGazCsvData");
  if(!raw){alert("Pas de CSV Gaz trouvÃ©.");return;}
  localStorage.removeItem("exportGazCsvData");

  const parsed=Papa.parse(raw,{header:true,dynamicTyping:true,skipEmptyLines:true});
  csvData=parsed.data;
  headers=parsed.meta.fields;

  document.getElementById("fileName").textContent="Export Gaz";
  document.getElementById("lineCount").textContent=csvData.length+" lignes";

  timeCol=headers.find(h=>/date|jour|time/i.test(h.toLowerCase())) || headers[0];

  csvData.forEach(r=>{
    const d=new Date(r[timeCol]);
    d.setHours(0,0,0,0);
    r.__day=d.getTime();
  });

  const yc=document.getElementById("yColumns");
  headers.forEach(h=>{
    if(h===timeCol)return;
    const lab=document.createElement("label");
    lab.innerHTML=`<input type="checkbox" value="${h}" checked> ${h}`;
    yc.appendChild(lab);
  });

  Yactive=headers.filter(h=>h!==timeCol);

  yc.addEventListener("change",()=>{
    Yactive=[...yc.querySelectorAll("input:checked")].map(c=>c.value);
    draw();
  });

  document.getElementById("backBtn").onclick=()=>window.close();
  document.getElementById("resetZoom").onclick=()=>{
    chart?.resetZoom();
    chart?.update();
  };

  draw();
})();
</script>
</body>
</html>
