<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Graphique CSV</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<style>
body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #fff0e5; margin: 0; padding: 5px 20px; color: #d84315; position: relative; }
.header { position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
.header .logo { height: 60px; width: auto; }
#fileNameContainer { position: absolute; right: 0; top: 0; text-align: right; }
#fileName, #lineCount { color: #e64a19; }
#fileName { font-size: 24px; font-weight: bold; white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis; display: none; }
#lineCount { font-size: 12px; display: none; }

.controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
button { background-color: #ff7043; color: white; border: none; cursor: pointer; font-weight: bold; padding: 8px 12px; border-radius: 6px; font-size: 13px; transition: background-color 0.3s ease, transform 0.2s ease; }
button:hover { background-color: #e64a19; transform: scale(1.05); }

.graph-wrapper { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 40px; } /* espace bas sous le canvas */
.graph-side { display: flex; flex-direction: column; gap: 10px; }
#myChart { background: transparent; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display:block; margin: 0 auto; max-width:100%; }
#zoomInfo { position: absolute; top: 80px; right: 20px; background: rgba(255,255,255,0.9); border: 1px solid #ff7043; border-radius: 6px; padding: 6px 10px; font-size: 12px; color: #ff7043; font-weight: bold; z-index: 10; pointer-events: none; }
</style>
</head>
<body>

<div class="header">
  <img src="img/logo.png" alt="Logo" class="logo" />
  <div id="fileNameContainer">
    <div id="fileName"></div>
    <div id="lineCount"></div>
  </div>
</div>

<div class="controls">
  <button id="backBtn">‚¨ÖÔ∏è Retour</button>
  <button id="exportPDF" style="display:none;">üìÑ Exporter PDF</button>
  <button id="resetZoom" style="display:none;">üîÑ R√©initialiser zoom</button>
  <button id="toggleSmooth">üéöÔ∏è Lissage: ON</button>
</div>

<div class="controls" id="columnSelectors" style="display:none;">
  <select id="xColumn"></select>
  <select id="yColumns" multiple></select>
  <button id="drawChartBtn">üìä Afficher courbes</button>
</div>

<div class="graph-wrapper">
  <div class="graph-side">
    <button id="extendPrev">‚¨ÖÔ∏è √âtendre veille</button>
    <button id="panPrev">‚è™ Avant</button>
  </div>

  <canvas id="myChart" width="1600" height="800"></canvas>

  <div class="graph-side">
    <button id="extendNext">√âtendre lendemain ‚û°Ô∏è</button>
    <button id="panNext">‚è© Apr√®s</button>
  </div>
</div>

<div id="zoomInfo">üîç S√©lectionner une zone avec le clic gauche pour zoomer</div>

<script>
const API_KEY='AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M';
let csvData=[], chart, currentX="", currentY=[];
let baseFileName="", baseFileId="", headers=[], timeField="", baseDateYYYYMMDD="";
let isSmooth=true;

const colors=["#e53935","#ff7043","#ffc300","#33ff57","#3380ff","#8e44ad","#ff33a6","#33cccc"];
const fileNameDiv=document.getElementById('fileName');
const lineCountDiv=document.getElementById('lineCount');
const exportBtn=document.getElementById('exportPDF');
const resetBtn=document.getElementById('resetZoom');
const xSelect=document.getElementById('xColumn');
const ySelect=document.getElementById('yColumns');
const drawBtn=document.getElementById('drawChartBtn');
const columnSelectors=document.getElementById('columnSelectors');
const zoomInfoDiv=document.getElementById('zoomInfo');
const toggleSmoothBtn=document.getElementById('toggleSmooth');

document.getElementById('backBtn').addEventListener('click',()=>{ window.close(); });

function getParam(n){ return new URLSearchParams(window.location.search).get(n); }
function parseSAFileName(fname){ const m=fname.match(/^SA(\d+)_(\d{8})/i); if(!m) return null; return { num:m[1].padStart(5,"0"), date:m[2] }; }
function shiftDate(dateStr, offsetDays){
  const year=parseInt(dateStr.substring(0,4),10);
  const month=parseInt(dateStr.substring(4,6),10)-1;
  const day=parseInt(dateStr.substring(6,8),10);
  const d=new Date(year,month,day);
  d.setDate(d.getDate()+offsetDays);
  return d.getFullYear()+String(d.getMonth()+1).padStart(2,"0")+String(d.getDate()).padStart(2,"0");
}
function yyyymmddToIso(d){ return d.slice(0,4)+"-"+d.slice(4,6)+"-"+d.slice(6,8); }
function makeSortKey(isoDateStr,timeStr){ return new Date(`${isoDateStr} ${timeStr||"00:00:00"}`).getTime(); }
function dedupeHeaders(arr){ let hc={}; return arr.map(h=>{const k=(h==null?"":String(h)); if(hc[k]){hc[k]++; return `${k}_${hc[k]}`;} hc[k]=1; return k;}); }

async function loadCSVByFileId(fileId){
  const url=`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`;
  const res=await fetch(url);
  if(!res.ok) return null;
  const text=new TextDecoder('windows-1252').decode(await res.arrayBuffer());
  return Papa.parse(text,{header:false,dynamicTyping:true,skipEmptyLines:true});
}
function buildObjectsFromParsedResults(results,hdrs){ return results.data.slice(1).map(row=>{let o={}; row.forEach((v,i)=>o[hdrs[i]]=v); return o;}); }
function enrichRowsWithDate(rows,yyyymmdd){ if(!timeField) return rows; const iso=yyyymmddToIso(yyyymmdd); rows.forEach(r=>{const t=r[timeField]; r.__dateISO=iso; r.__sortKey=makeSortKey(iso,t);}); return rows; }

async function loadCSVFromDrive(){
  baseFileId=getParam('fileId'); baseFileName=getParam('fileName')||'';
  if(!baseFileId){ alert('Aucun fichier sp√©cifi√©'); return; }

  fileNameDiv.textContent=baseFileName; fileNameDiv.style.display="block"; 
  lineCountDiv.style.display="block";
  exportBtn.style.display="inline-block"; 
  resetBtn.style.display="inline-block";

  const parsedBase=await loadCSVByFileId(baseFileId);
  if(!parsedBase){ alert('Impossible de charger le CSV'); return; }

  headers=dedupeHeaders(parsedBase.data[0]||[]);
  csvData=buildObjectsFromParsedResults(parsedBase,headers);
  lineCountDiv.textContent=csvData.length+" ligne"+(csvData.length>1?"s":"");

  // Remplissage X + Y (Y filtr√©)
  xSelect.innerHTML=""; ySelect.innerHTML="";
  let defX=headers.find(h=>h.toLowerCase().includes("time")||h.toLowerCase()==="heure");
  headers.forEach(f=>{
    const optX=document.createElement("option"); optX.value=f; optX.text=f; xSelect.appendChild(optX);
    const low=f.toLowerCase();
    if(f===defX || low.includes("time") || low.includes("date") || low.includes("jour")) return;
    const optY=document.createElement("option"); optY.value=f; optY.text=f; ySelect.appendChild(optY);
  });
  columnSelectors.style.display="flex";
  if(defX){ xSelect.value=defX; xSelect.style.display="none"; timeField=defX; }

  const p=parseSAFileName(baseFileName); 
  if(p){ baseDateYYYYMMDD=p.date; enrichRowsWithDate(csvData,baseDateYYYYMMDD); }

  zoomInfoDiv.style.display='block';
  setTimeout(()=>{ zoomInfoDiv.style.display='none'; }, 5000);
}

drawBtn.addEventListener('click', ()=>{
  currentX = xSelect.value || "heure";
  currentY = Array.from(ySelect.selectedOptions).map(o=>o.value);
  if(!currentY.length){ alert("Choisissez au moins une colonne pour Y."); return; }
  drawChart();
});

// Ticks adaptatifs (on conserve la logique), affichage HH:MM
function getTimeUnit(range){
  const oneDay=24*60*60*1000;
  if(range<=oneDay) return {unit:'hour',stepSize:2};
  if(range<=3*oneDay) return {unit:'hour',stepSize:6};
  if(range>=7*oneDay) return {unit:'day', stepSize:1};
  return {unit:'hour',stepSize:4};
}
function applyAdaptiveTicks(){
  if(!chart) return;
  const range=chart.scales.x.max-chart.scales.x.min;
  const cfg=getTimeUnit(range);
  chart.options.scales.x.time = chart.options.scales.x.time || {};
  chart.options.scales.x.time.unit = cfg.unit;
  chart.options.scales.x.time.stepSize = cfg.stepSize;
  chart.options.scales.x.ticks.callback = (val, idx, ticks) => {
    const d = new Date(ticks[idx].value);
    return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',hour12:false}); // HH:MM
  };
  chart.update('none');
}

function drawChart(){
  if(!csvData.length || !currentX) return;
  const ctx=document.getElementById('myChart').getContext('2d');

  const datasets=currentY.map((yCol,i)=>{
    const color=colors[i%colors.length];
    return {
      label:yCol,
      data:csvData.map(r=>({x:r.__sortKey,y:r[yCol]})),
      borderColor:color,
      borderWidth:2,
      fill:false,
      tension:isSmooth?0.8:0,
      cubicInterpolationMode:isSmooth?'monotone':undefined,
      pointRadius:0,
      pointHoverRadius:6,
      pointBackgroundColor:color,
      pointBorderColor:color
    };
  });

  // Fond altern√© + dates JJ/MM SOUS le graphe
  const dayBackgroundPlugin = {
    id:'dayBackground',
    beforeDraw(chart){
      const {ctx,scales:{x},chartArea}=chart;
      if(!x || !isFinite(x.min) || !isFinite(x.max)) return;
      const oneDay=24*60*60*1000;
      let start=new Date(x.min); start.setHours(0,0,0,0);
      let toggle=false;
      ctx.save();
      chart.options.layout={padding:{bottom:40}};
      for(let d=start.getTime(); d<x.max; d+=oneDay){
        const from=x.getPixelForValue(d), to=x.getPixelForValue(d+oneDay);
        ctx.fillStyle = toggle ? 'rgba(255,112,67,0.12)' : 'rgba(255,112,67,0.04)'; // deux oranges tr√®s clairs
        ctx.fillRect(from, chartArea.top, to-from, chartArea.bottom-chartArea.top);
        // Date JJ/MM sous le chartArea
        const label = new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'});
        ctx.fillStyle='#d84315';
        ctx.font='bold 14px Segoe UI';
        ctx.textAlign='center';
        ctx.textBaseline='top';
        ctx.fillText(label, (from+to)/2, chartArea.bottom+6);
        toggle=!toggle;
      }
      ctx.restore();
    }
  };

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:"line",
    data:{ datasets },
    options:{
      responsive:false,
      interaction:{ mode:'nearest', axis:'x', intersect:false },
      plugins:{
        legend:{ position:'top' },
        datalabels:{ display:false },
        zoom:{
          zoom:{ wheel:{enabled:true,modifierKey:'ctrl'}, pinch:{enabled:true}, drag:{enabled:true,mode:'x'} },
          pan:{ enabled:true, mode:'x' }
        }
      },
      scales:{
        x:{
          type:'time',
          ticks:{ autoSkip:true, maxRotation:0, minRotation:0 }
        },
        y:{ title:{ display:true, text:'Valeurs' } }
      }
    },
    plugins:[ChartDataLabels, dayBackgroundPlugin]
  });

  applyAdaptiveTicks();
}

// LISSAGE ON/OFF sans perdre le zoom
toggleSmoothBtn.addEventListener('click', ()=>{
  isSmooth = !isSmooth;
  toggleSmoothBtn.textContent = 'üéöÔ∏è Lissage: ' + (isSmooth?'ON':'OFF');
  if(!chart) return;
  chart.data.datasets.forEach(ds=>{
    ds.tension = isSmooth ? 0.8 : 0;
    ds.cubicInterpolationMode = isSmooth ? 'monotone' : undefined;
  });
  chart.update('none');
});

// √âtendre jours (concat√®ne)
async function extendWith(offset){
  const p=parseSAFileName(baseFileName); if(!p){ alert("Nom fichier incompatible"); return; }
  const neighborYYYYMMDD=shiftDate(p.date,offset);
  const neighborName=`SA${p.num}_${neighborYYYYMMDD}.csv`;
  const csvFiles=JSON.parse(localStorage.getItem("csvFilesList")||"[]");
  const neighborFile=csvFiles.find(f=>f.name===neighborName);
  if(!neighborFile){ alert("Fichier introuvable : "+neighborName); return; }
  const parsedNeighbor=await loadCSVByFileId(neighborFile.id);
  if(!parsedNeighbor){ alert("Impossible de charger "+neighborName); return; }
  const neighborRows=buildObjectsFromParsedResults(parsedNeighbor,headers);
  enrichRowsWithDate(neighborRows,neighborYYYYMMDD);
  csvData = csvData.concat(neighborRows).sort((a,b)=>(a.__sortKey||0)-(b.__sortKey||0));
  if(currentX&&currentY.length){ drawChart(); }
}

// Panner vue (Avant/Apr√®s) ‚Äî FIX : init min/max si absents
function shiftView(days){
  if(!chart) return;
  const sc = chart.scales.x;
  const delta = days*24*60*60*1000;
  const currMin = (chart.options.scales.x.min!=null) ? chart.options.scales.x.min : sc.min;
  const currMax = (chart.options.scales.x.max!=null) ? chart.options.scales.x.max : sc.max;
  chart.options.scales.x.min = currMin + delta;
  chart.options.scales.x.max = currMax + delta;
  chart.update('none');
  applyAdaptiveTicks();
}

document.getElementById('extendPrev').addEventListener('click',()=>extendWith(-1));
document.getElementById('extendNext').addEventListener('click',()=>extendWith(1));
document.getElementById('panPrev').addEventListener('click',()=>shiftView(-1));
document.getElementById('panNext').addEventListener('click',()=>shiftView(1));
document.getElementById('resetZoom').addEventListener('click',()=>{ if(chart){ chart.resetZoom(); chart.options.scales.x.min=undefined; chart.options.scales.x.max=undefined; applyAdaptiveTicks(); } });

// Export PDF (inchang√©)
exportBtn.addEventListener('click', () => {
  if (!chart) return;
  const { jsPDF } = window.jspdf;
  const canvas = chart.canvas;
  const pdf = new jsPDF({ orientation: 'landscape' });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const csvName = (getParam('fileName') || '').split('\\').pop() || '';
  let titleText = csvName;
  let pdfFileName = csvName.replace(/\.csv$/i, '.pdf');

  if (csvName.startsWith("Z")) {
    const matchZ = csvName.match(/^Z\d+(\d{2})_(\d{8})/);
    if (matchZ) {
      const xx = parseInt(matchZ[1],10).toString();
      const dateRaw = matchZ[2];
      const yyyy = dateRaw.substring(0,4), mm = dateRaw.substring(4,6), dd = dateRaw.substring(6,8);
      titleText = `Historique S√©choir ${xx} - ${dd}/${mm}/${yyyy}`;
    }
  } else {
    const match = csvName.match(/^SA(\d+)_([0-9]{8})/);
    if (match) {
      const numRaw = match[1];
      const numTwoDigits = parseInt(numRaw,10).toString().padStart(2,'0');
      const dateRaw = match[2];
      const yyyy = dateRaw.substring(0,4), mm = dateRaw.substring(4,6), dd = dateRaw.substring(6,8);
      titleText = parseInt(numRaw) > 0 ? `S√©choir ${parseInt(numRaw,10)} - ${dd}/${mm}/${yyyy}` : `${dd}/${mm}/${yyyy}`;
      pdfFileName = parseInt(numRaw) > 0 ? `S√©choir-${numTwoDigits}_${dateRaw}.pdf` : `${dateRaw}.pdf`;
    }
  }

  pdf.setFontSize(14);
  pdf.setTextColor(229,57,53);
  const lines = pdf.splitTextToSize(titleText, pageWidth - 20);
  pdf.text(lines, 14, 12);

  const scale = Math.min((pageWidth-20)/canvas.width, (pageHeight-30)/canvas.height);
  pdf.addImage(canvas.toDataURL('image/png'), 'PNG', (pageWidth - canvas.width*scale)/2, 20 + lines.length*5, canvas.width*scale, canvas.height*scale);
  pdf.save(pdfFileName);
});

(async function(){ 
  baseFileId=getParam('fileId'); 
  baseFileName=decodeURIComponent(getParam('fileName')||''); 
  await loadCSVFromDrive(); 
})();
</script>
</body>
</html>


















