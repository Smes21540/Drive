<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Graphique CSV</title>

<!-- Librairies -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
:root{
  --bg:#fff5f5;
  --panel:#ffffff;
  --accent:#ff7043;
  --accent-darker:#e64a19;
  --accent-muted:#ffccbc;
  --danger:#d84315;
  --text:#333;
  --shadow:rgba(0,0,0,0.1);
}

body {
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  background-color:var(--bg);
  margin:0; padding:5px 20px;
  color:var(--danger);
  position:relative;
  display:flex; flex-direction:column; min-height:100vh;
}

.header { position:relative; display:flex; align-items:center; justify-content:center; margin-bottom:10px; }
.header .logo { height:60px; width:auto; }
#fileNameContainer { position:absolute; right:0; top:0; text-align:right; }
#fileName,#lineCount { color:var(--accent-darker); }
#fileName { font-size:24px; font-weight:bold; white-space:nowrap; max-width:300px; overflow:hidden; text-overflow:ellipsis; display:none; }
#lineCount { font-size:12px; display:none; }

.controls { display:flex; justify-content:center; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
button {
  background-color:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:bold;
  padding:8px 12px; border-radius:6px; font-size:13px; transition:background-color .3s, transform .2s;
}
button:hover { background-color:var(--accent-darker); transform:scale(1.05); }
button:disabled { background:#ccc; color:#666; cursor:not-allowed; transform:none; }

.graph-wrapper { display:flex; align-items:center; justify-content:center; gap:20px; margin-bottom:40px; }
.graph-side { display:flex; flex-direction:column; gap:10px; }
#myChart { background:#fff; border-radius:8px; box-shadow:0 4px 12px var(--shadow); display:block; margin:0 auto; max-width:100%; }
#zoomInfo { position:absolute; top:80px; right:20px; background:rgba(255,255,255,0.9); border:1px solid var(--accent); border-radius:6px; padding:6px 10px; font-size:12px; color:var(--accent-darker); font-weight:bold; z-index:10; pointer-events:none; }

/* Spinner + erreur */
#spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:50px;height:50px;border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;z-index:2000;}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
#errorBox{display:none;position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:var(--accent-muted);padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:2001;text-align:center;color:var(--danger);font-weight:bold;}

/* Menu secret (th√®mes) */
#secretBtn{position:fixed;bottom:10px;right:10px;width:25px;height:25px;opacity:0;cursor:pointer;z-index:2000;}
#themeMenu{display:none;position:fixed;bottom:50px;right:10px;background: var(--panel);
  border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
  padding:10px;z-index:2001;min-width:150px;}
#themeMenu h3 {margin:0 0 8px 0;font-size:14px;color: var(--accent);}
#themeMenu .closeMenu {position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
#themeMenu .closeMenu:hover {color:var(--accent-darker);}
#themeMenu button {display:block;width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;background: var(--accent);color: white;cursor:pointer;font-size:13px;}
#themeMenu button:hover {background: var(--accent-darker);}
</style>
</head>
<body>

<div class="header">
  <img src="img/logo.png" alt="Logo" class="logo" />
  <div id="fileNameContainer">
    <div id="fileName"></div>
    <div id="lineCount"></div>
  </div>
</div>

<div class="controls">
  <button id="backBtn">‚¨ÖÔ∏è Retour</button>
  <button id="exportPDF" style="display:none;">üìÑ Exporter PDF</button>
  <button id="resetZoom" style="display:none;">üîÑ R√©initialiser zoom</button>
  <button id="toggleSmooth">üéöÔ∏è Lissage: ON</button>
</div>

<div class="controls" id="columnSelectors" style="display:none;">
  <select id="xColumn"></select>
  <select id="yColumns" multiple></select>
  <button id="drawChartBtn">üìä Afficher courbes</button>
</div>

<div class="graph-wrapper">
  <div class="graph-side">
    <button id="extendPrev">‚¨ÖÔ∏è √âtendre veille</button>
    <button id="panPrev">‚è™ Avant</button>
  </div>

  <canvas id="myChart" width="1600" height="800"></canvas>

  <div class="graph-side">
    <button id="extendNext">√âtendre lendemain ‚û°Ô∏è</button>
    <button id="panNext">‚è© Apr√®s</button>
  </div>
</div>

<div id="zoomInfo">üîç S√©lectionner une zone avec le clic gauche pour zoomer</div>
<div id="spinner"></div>
<div id="errorBox">
  ‚ö†Ô∏è Impossible de charger le fichier.<br>
  V√©rifiez la connexion ou r√©essayez plus tard.<br><br>
  <button onclick="window.location.reload()">R√©essayer</button>
</div>

<!-- Menu secret -->
<div id="secretBtn" title=" "></div>
<div id="themeMenu">
  <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
  <h3>Choisir un th√®me</h3>
  <button onclick="setTheme('orange')">Orange (d√©faut)</button>
  <button onclick="setTheme('blue')">Bleu</button>
  <button onclick="setTheme('green')">Vert</button>
  <button onclick="setTheme('purple')">Violet</button>
  <button onclick="setTheme('bordeaux')">Bordeaux</button>
</div>

<script>
/* ===================== CONFIG / STATE ===================== */
const API_KEY='AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M';
let csvData=[], chart, currentX="", currentY=[];
let baseFileName="", baseFileId="", headers=[], timeField="", baseDateYYYYMMDD="";
let isSmooth=true;
let themeMenuTimer;

/* ===================== THEME ===================== */
function applyThemeVars(vars){
  const r=document.documentElement;
  Object.entries(vars).forEach(([k,v])=>r.style.setProperty(k,v));
  // recalculer palette
  colors = buildPalette();
  // rafra√Æchir chart si d√©j√† dessin√©
  if(chart){
    chart.data.datasets.forEach((ds,i)=>{ ds.borderColor = colors[i%colors.length]; ds.pointBackgroundColor = ds.pointBorderColor = colors[i%colors.length]; });
    chart.update('none');
  }
}
function setTheme(theme){
  localStorage.setItem("selectedTheme",theme);
  if(theme==="orange")  applyThemeVars({"--accent":"#ff7043","--accent-darker":"#e64a19","--accent-muted":"#ffccbc","--bg":"#fff5f5","--panel":"#ffffff","--danger":"#d84315","--text":"#333"});
  if(theme==="blue")    applyThemeVars({"--accent":"#2196f3","--accent-darker":"#1976d2","--accent-muted":"#bbdefb","--bg":"#e3f2fd","--panel":"#ffffff","--danger":"#0d47a1","--text":"#0d47a1"});
  if(theme==="green")   applyThemeVars({"--accent":"#4caf50","--accent-darker":"#2e7d32","--accent-muted":"#c8e6c9","--bg":"#f1f8e9","--panel":"#ffffff","--danger":"#1b5e20","--text":"#1b5e20"});
  if(theme==="purple")  applyThemeVars({"--accent":"#9c27b0","--accent-darker":"#6a1b9a","--accent-muted":"#e1bee7","--bg":"#f3e5f5","--panel":"#ffffff","--danger":"#4a148c","--text":"#4a148c"});
  if(theme==="bordeaux")applyThemeVars({"--accent":"#800020","--accent-darker":"#4b0014","--accent-muted":"#d7a1a9","--bg":"#fff0f2","--panel":"#ffffff","--danger":"#600018","--text":"#4b0014"});
}
document.getElementById("secretBtn").onclick=()=>{const menu=document.getElementById("themeMenu");if(menu.style.display==="block"){closeThemeMenu();}else{menu.style.display="block";resetThemeMenuTimer();}};
function resetThemeMenuTimer(){clearTimeout(themeMenuTimer);themeMenuTimer=setTimeout(closeThemeMenu,10000);}
function closeThemeMenu(){document.getElementById("themeMenu").style.display="none";clearTimeout(themeMenuTimer);}
function getCSSVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function hexToRgb(hex){hex=hex.replace('#',''); if(hex.length===3){hex=hex.split('').map(h=>h+h).join('');} const n=parseInt(hex,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};}

/* ===================== COLORS for datasets ===================== */
function buildPalette(){
  const accent=getCSSVar('--accent'), danger=getCSSVar('--danger');
  // palette th√®me + compl√©mentaires
  return [accent,danger,"#3380ff","#4caf50","#8e44ad","#ff33a6","#33cccc","#ffc300"];
}
let colors = buildPalette();

/* ===================== SPINNER + ERROR ===================== */
function showSpinner(){document.getElementById('spinner').style.display='block';}
function hideSpinner(){document.getElementById('spinner').style.display='none';}
function showError(){hideSpinner();document.getElementById('errorBox').style.display='block';}

/* ===================== UTILS ===================== */
function getParam(n){ return new URLSearchParams(window.location.search).get(n); }
function parseSAFileName(fname){ const m=fname.match(/^SA(\d+)_(\d{8})/i); if(!m) return null; return { num:m[1].padStart(5,"0"), date:m[2] }; }
function shiftDate(dateStr, offsetDays){ const y=parseInt(dateStr.slice(0,4),10),m=parseInt(dateStr.slice(4,6),10)-1,d=parseInt(dateStr.slice(6,8),10);const dt=new Date(y,m,d);dt.setDate(dt.getDate()+offsetDays);return dt.getFullYear()+String(dt.getMonth()+1).padStart(2,"0")+String(dt.getDate()).padStart(2,"0"); }
function yyyymmddToIso(d){ return d.slice(0,4)+"-"+d.slice(4,6)+"-"+d.slice(6,8); }
function makeSortKey(isoDateStr,timeStr){ return new Date(`${isoDateStr} ${timeStr||"00:00:00"}`).getTime(); }
function dedupeHeaders(arr){ let hc={}; return arr.map(h=>{const k=(h==null?"":String(h)); if(hc[k]){hc[k]++; return `${k}_${hc[k]}`;} hc[k]=1; return k;}); }

/* ===================== FETCH CSV ===================== */
async function loadCSVByFileId(fileId){
  try{
    showSpinner();
    const url=`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text=new TextDecoder('windows-1252').decode(await res.arrayBuffer());
    hideSpinner();
    return Papa.parse(text,{header:false,dynamicTyping:true,skipEmptyLines:true});
  }catch(e){console.error(e);showError();return null;}
}
function buildObjectsFromParsedResults(results,hdrs){ return results.data.slice(1).map(row=>{let o={}; row.forEach((v,i)=>o[hdrs[i]]=v); return o;}); }
function enrichRowsWithDate(rows,yyyymmdd){ if(!timeField) return rows; const iso=yyyymmddToIso(yyyymmdd); rows.forEach(r=>{const t=r[timeField]; r.__dateISO=iso; r.__sortKey=makeSortKey(iso,t);}); return rows; }

/* ===================== LOAD CSV (base) ===================== */
async function loadCSVFromDrive(){
  baseFileId=getParam('fileId'); baseFileName=getParam('fileName')||'';
  if(!baseFileId){ showError(); return; }
  document.getElementById('fileName').textContent=baseFileName;
  document.getElementById('fileName').style.display="block";
  document.getElementById('lineCount').style.display="block";
  document.getElementById('exportPDF').style.display="inline-block";
  document.getElementById('resetZoom').style.display="inline-block";

  const parsedBase=await loadCSVByFileId(baseFileId);
  if(!parsedBase) return;

  headers=dedupeHeaders(parsedBase.data[0]||[]);
  csvData=buildObjectsFromParsedResults(parsedBase,headers);
  document.getElementById('lineCount').textContent=csvData.length+" ligne"+(csvData.length>1?"s":"");

  const xSel=document.getElementById('xColumn'),ySel=document.getElementById('yColumns');
  xSel.innerHTML=""; ySel.innerHTML="";
  let defX=headers.find(h=>h.toLowerCase().includes("time")||h.toLowerCase()==="heure");
  headers.forEach(f=>{
    const optX=document.createElement("option"); optX.value=f; optX.text=f; xSel.appendChild(optX);
    const low=f.toLowerCase();
    if(f===defX||low.includes("time")||low.includes("date")||low.includes("jour")) return;
    const optY=document.createElement("option"); optY.value=f; optY.text=f; ySel.appendChild(optY);
  });
  document.getElementById('columnSelectors').style.display="flex";
  if(defX){ xSel.value=defX; xSel.style.display="none"; timeField=defX; }

  const p=parseSAFileName(baseFileName);
  if(p){ baseDateYYYYMMDD=p.date; enrichRowsWithDate(csvData,baseDateYYYYMMDD); }
}

/* ===================== CHART ===================== */
function getTimeUnit(range){
  const oneDay=86400000;
  if(range<=oneDay) return {unit:'hour',stepSize:2};
  if(range<=3*oneDay) return {unit:'hour',stepSize:6};
  if(range>=7*oneDay) return {unit:'day',stepSize:1};
  return {unit:'hour',stepSize:4};
}
function applyAdaptiveTicks(){
  if(!chart) return;
  const range=chart.scales.x.max-chart.scales.x.min;
  const cfg=getTimeUnit(range);
  chart.options.scales.x.time = chart.options.scales.x.time || {};
  chart.options.scales.x.time.unit = cfg.unit;
  chart.options.scales.x.time.stepSize = cfg.stepSize;
  chart.options.scales.x.ticks.callback = (val, idx, ticks) => {
    const d=new Date(ticks[idx].value);
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  };
  chart.update('none');
}

function drawChart(){
  if(!csvData.length||!currentX) return;
  const ctx=document.getElementById('myChart').getContext('2d');

  const datasets=currentY.map((yCol,i)=>{
    const color=colors[i%colors.length];
    return {
      label:yCol,
      data:csvData.map(r=>({x:r.__sortKey,y:r[yCol]})),
      borderColor:color,
      borderWidth:3,
      fill:false,
      tension:isSmooth?0.85:0,
      cubicInterpolationMode:isSmooth?'monotone':undefined,
      pointRadius:0,
      pointHoverRadius:6,
      pointBackgroundColor:color,
      pointBorderColor:color
    };
  });

  const dayBackgroundPlugin = {
    id:'dayBackground',
    beforeDraw(chart){
      const {ctx,scales:{x},chartArea}=chart;
      if(!x||!isFinite(x.min)||!isFinite(x.max)) return;
      const oneDay=86400000;
      let start=new Date(x.min); start.setHours(0,0,0,0);
      let toggle=false;
      ctx.save();
      chart.options.layout={padding:{bottom:70}};
      for(let d=start.getTime(); d<x.max; d+=oneDay){
        const from=x.getPixelForValue(d), to=x.getPixelForValue(d+oneDay);
        const muted=getCSSVar('--accent-muted')||'rgba(255,112,67,0.12)';
        const veryLight='rgba(0,0,0,0.02)';
        ctx.fillStyle = toggle ? muted : veryLight;
        ctx.fillRect(from, chartArea.top, to-from, chartArea.bottom-chartArea.top);
        const label=new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'});
        ctx.fillStyle=getCSSVar('--danger')||'#d84315';
        ctx.font='bold 14px Segoe UI';
        ctx.textAlign='center';
        ctx.textBaseline='top';
        ctx.fillText(label, (from+to)/2, chartArea.bottom+36);
        toggle=!toggle;
      }
      ctx.restore();
    }
  };

  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"line",
    data:{datasets},
    options:{
      responsive:false,
      interaction:{mode:'nearest',axis:'x',intersect:false},
      plugins:{
        legend:{position:'top'},
        datalabels:{display:false},
        zoom:{
          zoom:{wheel:{enabled:true,modifierKey:'ctrl'},pinch:{enabled:true},drag:{enabled:true,mode:'x'}},
          pan:{enabled:true,mode:'x'}
        }
      },
      scales:{
        x:{type:'time',ticks:{autoSkip:true,maxRotation:0,minRotation:0}},
        y:{title:{display:true,text:'Valeurs'}}
      }
    },
    plugins:[ChartDataLabels, dayBackgroundPlugin]
  });

  applyAdaptiveTicks();
}

/* ===================== ACTIONS UI ===================== */
document.getElementById('backBtn').onclick=()=>window.close();
document.getElementById('drawChartBtn').onclick=()=>{
  currentX=document.getElementById('xColumn').value;
  currentY=Array.from(document.getElementById('yColumns').selectedOptions).map(o=>o.value);
  if(!currentY.length){ alert("Choisissez au moins une colonne pour Y."); return; }
  drawChart();
};
document.getElementById('toggleSmooth').onclick=()=>{
  isSmooth=!isSmooth;
  document.getElementById('toggleSmooth').textContent='üéöÔ∏è Lissage: '+(isSmooth?'ON':'OFF');
  if(chart){
    chart.data.datasets.forEach(ds=>{
      ds.tension=isSmooth?0.85:0;
      ds.cubicInterpolationMode=isSmooth?'monotone':undefined;
    });
    chart.update('none');
  }
};
document.getElementById('extendPrev').onclick=()=>extendWith(-1);
document.getElementById('extendNext').onclick=()=>extendWith(1);
document.getElementById('panPrev').onclick=()=>shiftView(-1);
document.getElementById('panNext').onclick=()=>shiftView(1);
document.getElementById('resetZoom').onclick=()=>{
  if(chart){
    chart.resetZoom();
    chart.options.scales.x.min=undefined;
    chart.options.scales.x.max=undefined;
    applyAdaptiveTicks();
  }
};

/* ===================== √âTENDRE / PAN ===================== */
async function extendWith(offset){
  const p=parseSAFileName(baseFileName); if(!p){ alert("Nom de fichier incompatible"); return; }
  const neighbor=shiftDate(p.date,offset);
  const neighborName=`SA${p.num}_${neighbor}.csv`;
  const csvFiles=JSON.parse(localStorage.getItem("csvFilesList")||"[]");
  const neighborFile=csvFiles.find(f=>f.name===neighborName);
  if(!neighborFile){ alert("Fichier introuvable : "+neighborName); return; }
  const parsed=await loadCSVByFileId(neighborFile.id);
  if(!parsed) return;
  const neighborRows=buildObjectsFromParsedResults(parsed,headers);
  enrichRowsWithDate(neighborRows,neighbor);
  csvData=csvData.concat(neighborRows).sort((a,b)=>(a.__sortKey||0)-(b.__sortKey||0));
  if(currentX&&currentY.length) drawChart();
}

function shiftView(days){
  if(!chart) return;
  const sc=chart.scales.x,delta=days*86400000;
  const currMin=(chart.options.scales.x.min!=null)?chart.options.scales.x.min:sc.min;
  const currMax=(chart.options.scales.x.max!=null)?chart.options.scales.x.max:sc.max;
  chart.options.scales.x.min=currMin+delta;
  chart.options.scales.x.max=currMax+delta;
  chart.update('none');
  applyAdaptiveTicks();
}

/* ===================== EXPORT PDF (th√®me + noms SA/Z) ===================== */
document.getElementById('exportPDF').onclick=()=>{
  if(!chart) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'landscape' });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const csvName = (getParam('fileName') || '').split('\\').pop() || '';
  let titleText = csvName;
  let pdfFileName = csvName.replace(/\.csv$/i, '.pdf');

  if (csvName.startsWith("Z")) {
    const matchZ = csvName.match(/^Z\d+(\d{2})_(\d{8})/);
    if (matchZ) {
      const xx = parseInt(matchZ[1],10).toString();
      const dateRaw = matchZ[2];
      const yyyy = dateRaw.substring(0,4), mm = dateRaw.substring(4,6), dd = dateRaw.substring(6,8);
      titleText = `Historique S√©choir ${xx} - ${dd}/${mm}/${yyyy}`;
      pdfFileName = csvName.replace(/\.csv$/i, '.pdf');
    }
  } else {
    const match = csvName.match(/^SA(\d+)_([0-9]{8})/);
    if (match) {
      const numRaw = match[1];
      const numTwoDigits = parseInt(numRaw,10).toString().padStart(2,'0');
      const dateRaw = match[2];
      const yyyy = dateRaw.substring(0,4), mm = dateRaw.substring(4,6), dd = dateRaw.substring(6,8);
      titleText = parseInt(numRaw) > 0 ? `S√©choir ${parseInt(numRaw,10)} - ${dd}/${mm}/${yyyy}` : `${dd}/${mm}/${yyyy}`;
      pdfFileName = parseInt(numRaw) > 0 ? `S√©choir-${numTwoDigits}_${dateRaw}.pdf` : `${dateRaw}.pdf`;
    }
  }

  // Couleur titre = --danger du th√®me
  const danger = getCSSVar('--danger') || '#d84315';
  const {r,g,b} = hexToRgb(danger);
  pdf.setFontSize(14);
  pdf.setTextColor(r,g,b);
  const lines = pdf.splitTextToSize(titleText, pageWidth - 20);
  pdf.text(lines, 14, 12);

  // image du canvas (les couleurs de courbes suivent d√©j√† le th√®me)
  const canvas = chart.canvas;
  const scale = Math.min((pageWidth-20)/canvas.width, (pageHeight-30)/canvas.height);
  pdf.addImage(canvas.toDataURL('image/png'), 'PNG',
    (pageWidth - canvas.width*scale)/2,
    20 + lines.length*5,
    canvas.width*scale,
    canvas.height*scale
  );
  pdf.save(pdfFileName);
};

/* ===================== INIT ===================== */
(async function(){
  // th√®me persistant
  const savedTheme=localStorage.getItem("selectedTheme")||"orange";
  setTheme(savedTheme);

  baseFileId=getParam('fileId'); 
  baseFileName=decodeURIComponent(getParam('fileName')||'');
  await loadCSVFromDrive();

  // info zoom
  const zoomInfo=document.getElementById('zoomInfo');
  zoomInfo.style.display='block';
  setTimeout(()=>{ zoomInfo.style.display='none'; }, 5000);
})();
</script>
</body>
</html>


