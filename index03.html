<script>
/* ========= Th√®me ========= */
function applyThemeVars(vars){
  const r=document.documentElement;
  Object.entries(vars).forEach(([k,v])=>r.style.setProperty(k,v));
}
function setTheme(theme){
  localStorage.setItem("selectedTheme",theme);
  if(theme==="orange") applyThemeVars({"--accent":"#ff7043","--accent-darker":"#e64a19","--accent-muted":"#ffccbc","--bg":"#fff5f5","--panel":"#ffffff","--danger":"#d84315","--text":"#333"});
  if(theme==="blue")   applyThemeVars({"--accent":"#2196f3","--accent-darker":"#1976d2","--accent-muted":"#bbdefb","--bg":"#e3f2fd","--panel":"#ffffff","--danger":"#0d47a1","--text":"#0d47a1"});
  if(theme==="green")  applyThemeVars({"--accent":"#4caf50","--accent-darker":"#2e7d32","--accent-muted":"#c8e6c9","--bg":"#f1f8e9","--panel":"#ffffff","--danger":"#1b5e20","--text":"#1b5e20"});
  if(theme==="purple") applyThemeVars({"--accent":"#9c27b0","--accent-darker":"#6a1b9a","--accent-muted":"#e1bee7","--bg":"#f3e5f5","--panel":"#ffffff","--danger":"#4a148c","--text":"#4a148c"});
  if(theme==="bordeaux")applyThemeVars({"--accent":"#800020","--accent-darker":"#4b0014","--accent-muted":"#d7a1a9","--bg":"#fff0f2","--panel":"#ffffff","--danger":"#600018","--text":"#4b0014"});
}

/* ========= En-t√™te dossier (comme viewer02) ========= */
function hydrateFolderHeader(){
  const params=new URLSearchParams(window.location.search);
  const fileId=params.get("fileId");
  const fileName=params.get("fileName");
  let title="";
  try{
    const list = JSON.parse(localStorage.getItem("csvFilesList")||"[]");
    const f = list.find(x=>x.id===fileId);
    if(f && f.parents && f.parents.length){
      const parent = list.find(x=>x.id===f.parents[0]);
      if(parent && parent.name){
        title = parent.name;
        if(parent.parents && parent.parents.length){
          const root = list.find(x=>x.id===parent.parents[0]);
          if(root && root.name) title = root.name+" / "+parent.name;
        }
      }
    }
  }catch(e){ console.warn("csvFilesList absent ou invalide", e); }
  if(!title) title = decodeURIComponent(fileName||"");

  const flameTitle = title.replace(/üî•/g,'<span class="flame" title="Br√ªleur(s) actuellement en fonctionnement">üî•</span>');
  const el = document.getElementById("currentFolderName");
  if(el) el.innerHTML = flameTitle;
}

/* ========= √âtat global ========= */
let csvData=[], headers=[], planLayout=[];
let hasTempExt=false, rowsCount=0, colsCount=0;

const params=new URLSearchParams(window.location.search);
const fileId=params.get("fileId");
const fileName=params.get("fileName");

/* ========= Plan depuis localStorage ========= */
function loadPlan(){
  const grid=document.getElementById("grid");
  const planRaw=localStorage.getItem("planSondes");
  if(!planRaw){
    grid.innerHTML="<b style='color:red'>‚ùå Aucun plan_sondes.csv trouv√© dans localStorage (cl√©: planSondes)</b>";
    console.error("planSondes manquant. Exemple rapide :", "localStorage.setItem('planSondes','01,02,03\\n04,05,06')");
    return;
  }

  // Lignes vides = s√©parateurs visuels (on mettra null)
  const rows=planRaw.trim().split(/\r?\n/).map(l=>{
    const cols=l.split(",").map(v=>v.trim());
    return cols.every(v=>v==="") ? null : cols;
  });

  planLayout=rows;
  rowsCount = planLayout.filter(r=>r).length;
  const firstNonEmpty = planLayout.find(r=>r);
  colsCount = firstNonEmpty ? firstNonEmpty.length : 0;

  buildGrid();
}

function buildGrid(){
  const grid=document.getElementById("grid");
  grid.style.gridTemplateColumns=`repeat(${colsCount}, var(--tile-size))`;
  grid.innerHTML="";

  for(const row of planLayout){
    if(!row){
      // ligne vide = espace visuel (s√©parateur haut/bas)
      const spacer=document.createElement("div");
      spacer.style.gridColumn=`1 / span ${colsCount}`;
      spacer.style.height="calc(var(--tile-size) * 0.3)";
      spacer.style.display="block";
      grid.appendChild(spacer);
      continue;
    }
    for(const num of row){
      if(!num) continue; // cellule vide √©ventuelle
      const div=document.createElement("div");
      div.className="sonde";
      div.id="sonde"+num;
      div.innerHTML=`
        <div class="label">Sonde ${num}</div>
        <div class="consigne">-- ¬∞C</div>
        <div class="val">-- ¬∞C</div>`;
      grid.appendChild(div);
    }
  }
}

/* ========= CSV Google Drive ========= */
async function loadCSV(){
  if(!fileId){ console.error("‚ùå fileId manquant dans l'URL"); return; }

  // Affiche nom + compte lignes (quand dispo)
  const fn=document.getElementById("fileName");
  if(fn) fn.textContent = decodeURIComponent(fileName||"");

  const url=`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M`;
  let text="";
  try{
    const res=await fetch(url);
    if(!res.ok){
      console.error("√âchec fetch CSV", res.status, res.statusText);
      return;
    }
    text=await res.text();
  }catch(e){
    console.error("Fetch CSV erreur r√©seau:", e);
    return;
  }

  if(typeof Papa==="undefined"){
    console.error("PapaParse introuvable. V√©rifie libs/papaparse.min.js (ou utilise un CDN).");
    return;
  }

  const seen={};
  const results=Papa.parse(text,{
    header:true, skipEmptyLines:true,
    transformHeader:(h)=>{
      h=(h||"").replace(/"/g,"").trim();
      if(seen[h]){ seen[h]++; return h+"_"+seen[h]; }
      else{ seen[h]=1; return h+"_1"; }
    }
  });

  headers = results.meta?.fields || [];
  csvData = results.data || [];

  const lc=document.getElementById("lineCount");
  if(lc) lc.textContent = (csvData?.length||0) + " ligne" + ((csvData?.length||0)>1?"s":"");

  document.getElementById("slider").max = Math.max(0, (csvData.length||1)-1);

  hasTempExt = headers.some(h => (h||"").toUpperCase().startsWith("T¬∞C EXT"));
  const extEl = document.getElementById("TempExt");
  if(extEl) extEl.style.display = hasTempExt ? "flex" : "none";

  const minInit=parseFloat(localStorage.getItem("scaleMin")||"15");
  const maxInit=parseFloat(localStorage.getItem("scaleMax")||"70");
  document.getElementById("minInput").value = isNaN(minInit)?15:minInit;
  document.getElementById("maxInput").value = isNaN(maxInit)?70:maxInit;

  updateGrid(0);
}

/* ========= Affichage d‚Äôune ligne ========= */
function updateGrid(idx){
  if(!csvData[idx]) return;
  const row=csvData[idx];

  const dateKey=headers.find(h=>(h||"").toLowerCase().includes("date"));
  const timeKey=headers.find(h=>{
    const hh=(h||"").toLowerCase();
    return hh.includes("heure") || hh.includes("time") || hh==="h";
  });

  let dtLabel="";
  if(dateKey && row[dateKey]) dtLabel += String(row[dateKey]);
  if(timeKey && row[timeKey]) dtLabel += (dtLabel?" ‚Äî ":"") + String(row[timeKey]);
  document.getElementById("datetimeLabel").textContent = dtLabel||("");

  // tuiles du plan
  planLayout.flat().forEach(i=>{
    if(!i) return; // ignore s√©parateurs
    const sondeNum=String(i).padStart(2,"0");
    const consCol="Sonde"+sondeNum+"_1";
    const valCol ="Sonde"+sondeNum+"_2";
    const div=document.getElementById("sonde"+i);
    if(!div) return;

    const cons=parseFloat(row[consCol]);
    const val =parseFloat(row[valCol]);

    div.querySelector(".consigne").textContent = isNaN(cons) ? "-- ¬∞C" : cons.toFixed(1)+" ¬∞C";
    const valDiv = div.querySelector(".val");
    if(!isNaN(val)){
      valDiv.textContent = val.toFixed(1)+" ¬∞C";
      div.style.background = getColor(val);
    }else{
      valDiv.textContent = "-- ¬∞C";
      div.style.background = "#eee";
    }
  });

  updateSpecial("Sonde AC sup","SondeACsup",row);
  updateSpecial("Sonde AC inf","SondeACinf",row);
  updateSpecial("Temp Grain","TempGrain",row);
  updateSpecial("T¬∞C Ext","TempExt",row);
}

function updateSpecial(label,id,row){
  const card=document.getElementById(id);
  if(!card) return;
  const consCol=headers.find(h=>(h||"").toUpperCase()===label.toUpperCase()+"_1");
  const valCol =headers.find(h=>(h||"").toUpperCase()===label.toUpperCase()+"_2");
  if(!consCol || !valCol) return;

  const cons=parseFloat(row[consCol]);
  const val =parseFloat(row[valCol]);

  card.querySelector(".consigne").textContent = isNaN(cons) ? "-- ¬∞C" : cons.toFixed(1)+" ¬∞C";
  const valDiv = card.querySelector(".val");
  if(!isNaN(val)){
    valDiv.textContent = val.toFixed(1)+" ¬∞C";
    card.style.background = getColor(val);
  }else{
    valDiv.textContent = "-- ¬∞C";
    card.style.background = "#eee";
  }
}

/* ========= Palette couleur ========= */
function getScale(){
  let min=parseFloat(document.getElementById("minInput").value);
  let max=parseFloat(document.getElementById("maxInput").value);
  if(!isFinite(min)) min=15;
  if(!isFinite(max)) max=70;
  if(max<=min) max=min+1;
  return {min,max};
}
function getColor(v){
  const {min,max}=getScale();
  let t=(v-min)/(max-min); t=Math.max(0,Math.min(1,t));
  if(t<0.5){ const r=t/0.5; return `rgb(0,${Math.round(150+105*r)},${Math.round(255-255*r)})`; }
  else if(t<0.75){ const r=(t-0.5)/0.25; return `rgb(${Math.round(255*r)},255,0)`; }
  else if(t<0.9){ const r=(t-0.75)/0.15; return `rgb(255,${Math.round(255-90*r)},0)`; }
  else{ const r=(t-0.9)/0.1; return `rgb(255,${Math.round(165-165*r)},0)`; }
}

/* ========= Listeners ========= */
document.getElementById("slider").addEventListener("input",e=>{
  const i=parseInt(e.target.value)||0;
  updateGrid(i);
});
document.getElementById("minInput").addEventListener("change",()=>{
  const v=parseFloat(document.getElementById("minInput").value);
  localStorage.setItem("scaleMin", isFinite(v)? String(v): "15");
  if(csvData.length) updateGrid(parseInt(document.getElementById("slider").value)||0);
});
document.getElementById("maxInput").addEventListener("change",()=>{
  const v=parseFloat(document.getElementById("maxInput").value);
  localStorage.setItem("scaleMax", isFinite(v)? String(v): "70");
  if(csvData.length) updateGrid(parseInt(document.getElementById("slider").value)||0);
});

/* ========= INIT ========= */
(function init(){
  try{
    setTheme(localStorage.getItem("selectedTheme")||"orange");
  }catch(e){ console.warn("setTheme a √©chou√©", e); }
  try{
    hydrateFolderHeader();
  }catch(e){ console.warn("hydrateFolderHeader a √©chou√©", e); }
  try{
    loadPlan();
  }catch(e){ console.error("loadPlan a √©chou√©", e); }
  try{
    loadCSV();
  }catch(e){ console.error("loadCSV a √©chou√©", e); }
})();
</script>
