<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tra√ßabilit√© S√©choir</title>
<style>
:root{
  --bg:#fff5f5;
  --panel:#fff0e5;
  --sidebar-bg:#ffe5d9;
  --text:#333;
  --muted-text:#555;
  --shadow:rgba(0,0,0,0.1);
  --accent:#ff7043;
  --accent-darker:#e64a19;
  --accent-muted:#ffccbc;
  --danger:#d84315;
}

html,body{height:100%;margin:0;overflow:hidden;}
body { 
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
  background-color: var(--panel); 
  padding: 5px 20px 7px 20px; 
  color: var(--danger); 
  font-size: 14px; 
  display:flex;
  flex-direction:column;
}

.header { position: relative; display: flex; align-items: center; justify-content: center; margin: 0 0 10px 0; }
.header .logo { height: 60px; width: auto; }
#fileNameContainer { position: absolute; right: 0; top: 0; text-align: right; }
#fileName, #lineCount { color: var(--danger); }
#fileName { font-size: 24px; font-weight: bold; white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis; display: none; }
#lineCount { font-size: 12px; display: none; }

.controls, #columnToggles { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 5px 0; }
button { background-color: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; padding: 8px 12px; border-radius: 6px; font-size: 13px; transition: background-color 0.3s ease, transform 0.2s ease; }
button:hover { background-color: var(--accent-darker); transform: scale(1.05); }
#toggleColumnsBtn { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--accent-darker); background-color: var(--accent); color: white; cursor: pointer; font-size: 13px; }
#toggleColumnsBtn:hover { background-color: var(--accent-darker); }

#tableWrapper { flex:1; overflow-y:auto; text-align:center; }
#tableContainer { display: inline-block; overflow: auto; min-width:100%; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow); background: var(--panel); text-align: center; }

table { width: auto; border-collapse: separate; border-spacing: 0; table-layout: auto; font-size: 13px; }
thead th, tbody td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--sidebar-bg); white-space: nowrap; transition: background-color 0.6s ease, color 0.6s ease; }
thead th { position: sticky; top: 0; z-index: 2; background-color: var(--accent); color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; user-select: none; font-size: 12px; }
thead th:hover { background-color: var(--accent-darker); }
tbody tr:nth-child(even) { background-color: var(--sidebar-bg); }
tbody tr:nth-child(odd) { background-color: var(--panel); }
tbody tr:hover { background-color: var(--accent-muted); transition: background-color 0.3s ease; }
thead th.sorted-asc::after { content: " ‚ñ≤"; font-size: 10px; }
thead th.sorted-desc::after { content: " ‚ñº"; font-size: 10px; }

#columnToggles label { font-size: 12px; cursor: pointer; margin-right:5px; }
#columnToggles input[type="checkbox"] { width: 14px; height: 14px; vertical-align: middle; margin-right:3px; }
#columnToggles { display: none; }

.flash-red { animation: flashRed 0.6s ease; }
@keyframes flashRed { 0% { background-color: var(--accent-muted); } 100% { background-color: var(--panel); } }

/* Menu secret */
#secretBtn{position:fixed;bottom:10px;right:10px;width:25px;height:25px;opacity:0;cursor:pointer;z-index:2000;}
#themeMenu{display:none;position:fixed;bottom:50px;right:10px;background: var(--panel);
  border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 12px var(--shadow);
  padding:10px;z-index:2001;min-width:150px;}
#themeMenu h3 {margin:0 0 8px 0;font-size:14px;color: var(--accent);}
#themeMenu .closeMenu {position:absolute;top:5px;right:8px;font-size:14px;cursor:pointer;color:var(--accent);}
#themeMenu .closeMenu:hover {color:var(--accent-darker);}
#themeMenu button {display:block;width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;background: var(--accent);color: white;cursor:pointer;font-size:13px;}
#themeMenu button:hover {background: var(--accent-darker);}
</style>
</head>
<body>

<div class="header">
  <img src="img/logo.png" alt="Logo SMES France" class="logo" id="mainLogo"/>
  <div id="fileNameContainer">
    <div id="fileName"></div>
    <div id="lineCount"></div>
  </div>
</div>

<div class="controls">
  <button id="backBtn">‚¨ÖÔ∏è Retour</button>
  <button id="prevFile">‚¨ÖÔ∏è Fichier pr√©c√©dent</button>
  <button id="nextFile">Fichier suivant ‚û°Ô∏è</button>
  <input type="text" id="searchInput" placeholder="üîé Rechercher..." />
  <button id="exportExcel">üìä Export Excel</button>
  <button id="exportPDF">üìÑ Export PDF</button>
  <button id="toggleColumnsBtn">Afficher/Masquer colonnes</button>
  <button id="resetBtn">‚ôªÔ∏è R√©initialiser affichage</button>
</div>

<div id="columnToggles"></div>
<div id="tableWrapper"><div id="tableContainer"></div></div>

<!-- Menu secret -->
<div id="secretBtn"></div>
<div id="themeMenu">
  <span class="closeMenu" onclick="closeThemeMenu()">‚ùå</span>
  <h3>Choisir un th√®me</h3>
  <button onclick="setTheme('orange')">Orange (d√©faut)</button>
  <button onclick="setTheme('blue')">Bleu</button>
  <button onclick="setTheme('green')">Vert</button>
  <button onclick="setTheme('purple')">Violet</button>
  <button onclick="setTheme('bordeaux')">Bordeaux</button>
</div>

<script src="libs/papaparse.min.js"></script>
<script src="libs/xlsx.full.min.js"></script>
<script src="libs/jspdf.umd.min.js"></script>
<script src="libs/jspdf.plugin.autotable.min.js"></script>
<script>
// === Variables ===
const API_KEY='AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M';
let currentData=[], sortAsc=true, sortColIndex=null, visibleColumns={}, columnVisibilityMemory={}, columnSortMemory={colName:null,asc:true}, lastSearchQuery="";
let themeMenuTimer;
let csvFilesList=[], currentIndex=0;

// === Th√®mes ===
function setTheme(theme){
  const r=document.documentElement;
  const logo=document.getElementById("mainLogo");
  logo.style.display=(theme==="orange")?"block":"none";
  localStorage.setItem("selectedTheme",theme);

  if(theme==="orange"){r.style.setProperty("--accent","#ff7043");r.style.setProperty("--accent-darker","#e64a19");r.style.setProperty("--accent-muted","#ffccbc");r.style.setProperty("--bg","#fff5f5");r.style.setProperty("--panel","#fff0e5");r.style.setProperty("--sidebar-bg","#ffe5d9");r.style.setProperty("--danger","#d84315");r.style.setProperty("--text","#333");r.style.setProperty("--muted-text","#555");}
  if(theme==="blue"){r.style.setProperty("--accent","#2196f3");r.style.setProperty("--accent-darker","#1976d2");r.style.setProperty("--accent-muted","#bbdefb");r.style.setProperty("--bg","#e3f2fd");r.style.setProperty("--panel","#e3f2fd");r.style.setProperty("--sidebar-bg","#bbdefb");r.style.setProperty("--danger","#0d47a1");r.style.setProperty("--text","#0d47a1");r.style.setProperty("--muted-text","#333");}
  if(theme==="green"){r.style.setProperty("--accent","#4caf50");r.style.setProperty("--accent-darker","#2e7d32");r.style.setProperty("--accent-muted","#c8e6c9");r.style.setProperty("--bg","#f1f8e9");r.style.setProperty("--panel","#f1f8e9");r.style.setProperty("--sidebar-bg","#c8e6c9");r.style.setProperty("--danger","#1b5e20");r.style.setProperty("--text","#1b5e20");r.style.setProperty("--muted-text","#333");}
  if(theme==="purple"){r.style.setProperty("--accent","#9c27b0");r.style.setProperty("--accent-darker","#6a1b9a");r.style.setProperty("--accent-muted","#e1bee7");r.style.setProperty("--bg","#f3e5f5");r.style.setProperty("--panel","#f3e5f5");r.style.setProperty("--sidebar-bg","#e1bee7");r.style.setProperty("--danger","#4a148c");r.style.setProperty("--text","#4a148c");r.style.setProperty("--muted-text","#333");}
  if(theme==="bordeaux"){r.style.setProperty("--accent","#800020");r.style.setProperty("--accent-darker","#4b0014");r.style.setProperty("--accent-muted","#d7a1a9");r.style.setProperty("--bg","#fff0f2");r.style.setProperty("--panel","#fff0f2");r.style.setProperty("--sidebar-bg","#f3cdd3");r.style.setProperty("--danger","#600018");r.style.setProperty("--text","#4b0014");r.style.setProperty("--muted-text","#333");}
}
document.getElementById("secretBtn").onclick=()=>{const menu=document.getElementById("themeMenu");if(menu.style.display==="block"){closeThemeMenu();}else{menu.style.display="block";resetThemeMenuTimer();}};
function resetThemeMenuTimer(){clearTimeout(themeMenuTimer);themeMenuTimer=setTimeout(closeThemeMenu,10000);}
function closeThemeMenu(){document.getElementById("themeMenu").style.display="none";clearTimeout(themeMenuTimer);}

// === Navigation fichiers ===
function loadCSVByIndex(index){
  if(index<0 || index>=csvFilesList.length) return;
  currentIndex=index;
  localStorage.setItem("csvFileIndex", currentIndex);
  const file=csvFilesList[currentIndex];
  if(file) loadCSV(file.id, file.name);
}
document.getElementById("prevFile").onclick=()=>loadCSVByIndex(currentIndex-1);
document.getElementById("nextFile").onclick=()=>loadCSVByIndex(currentIndex+1);

// === Charger CSV ===
async function loadCSV(fileId, fileName){
  const fileNameDiv=document.getElementById('fileName');
  const lineCountDiv=document.getElementById('lineCount');

  fileNameDiv.textContent=fileName||'';
  fileNameDiv.style.display='block';
  lineCountDiv.style.display='block';

  const url=`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`;
  const response=await fetch(url);
  const blob=await response.blob();
  const arrayBuffer=await blob.arrayBuffer();
  const text=new TextDecoder('windows-1252').decode(arrayBuffer);
  const results=Papa.parse(text,{header:false,skipEmptyLines:true});
  currentData=results.data;
  const rowCount=currentData.length>1?currentData.length-1:0;
  lineCountDiv.textContent=rowCount+" ligne"+(rowCount!==1?"s":"");
  renderTable(currentData);
}

// === Table rendering, tri, recherche, exports ===
// (reprend ton code existant, inchang√© sauf que loadCSVByIndex g√®re la navigation)

function escapeHtml(str){return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#039;"}[m]));}
// ... reste inchang√© (renderTable, toggleColumn, sortTable, search, reset, exportExcel, exportPDF) ...

// === Retour ===
document.getElementById('backBtn').onclick=()=>{window.close();};

// === Init ===
window.onload=()=>{
  const savedTheme=localStorage.getItem("selectedTheme")||"orange";
  setTheme(savedTheme);

  csvFilesList = JSON.parse(localStorage.getItem("csvFilesList")||"[]");
  currentIndex = parseInt(localStorage.getItem("csvFileIndex")||"0",10);

  if(csvFilesList.length>0){
    loadCSVByIndex(currentIndex);
  }else{
    // fallback : param√®tres URL
    const params=new URLSearchParams(window.location.search);
    const fileId=params.get("fileId"), fileName=params.get("fileName");
    if(fileId) loadCSV(fileId,fileName);
  }
};
</script>
</body>
</html>
