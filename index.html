<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SMES CSV Explorateur</title>
<style>
/* --- Styles identiques à avant --- */
body { font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#fff8f5; margin:0; padding:0; display:flex; height:100vh; overflow:hidden;}
#sidebar { width:300px; background:#fbe9e7; border-right:2px solid #e53935; padding:20px 10px; overflow-y:auto; transition:transform 0.3s ease; z-index:1000; -webkit-overflow-scrolling: touch; }
#folderTree ul { list-style:none; padding-left:20px; margin:0; }
#folderTree li { cursor:pointer; margin:5px 0; }
.folder-toggle { font-weight:bold; margin-right:5px; cursor:pointer; color:#e53935; }
.folder-name { cursor:pointer; }
.active-folder { background:#ffccbc; border-radius:3px; padding:2px 4px; }
#main { flex:1; padding:10px 20px; display:flex; flex-direction:column; overflow:hidden; transition:margin-left 0.3s;}
.header { display:flex; align-items:center; justify-content:center; position:relative; margin-bottom:15px; }
.header .logo { height:60px; width:auto; }
#fileNameContainer { position:absolute; right:0; top:0; text-align:right; }
#fileName,#lineCount{ color:#800000; }
#fileName{ font-size:20px; font-weight:bold; white-space:nowrap; max-width:250px; overflow:hidden; text-overflow:ellipsis; display:none; }
#lineCount{ font-size:12px; display:none; }
.controls { display:flex; flex-wrap:wrap; justify-content:flex-start; gap:10px; margin-bottom:10px; }
.controls button{ background:#e53935; color:white; border:none; cursor:pointer; font-weight:bold; padding:6px 12px; border-radius:6px; font-size:13px; transition:0.3s; }
.controls button:hover{ background:#c62828; transform:scale(1.05); }
.controls input[type=date]{ padding:5px; }
#tableWrapper { flex:1; overflow:auto; }
#tableContainer { overflow:auto; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); background:white; }
table { border-collapse:separate; border-spacing:0; width:100%; font-size:13px; table-layout:auto; }
thead th, tbody td { padding:10px 12px; text-align:left; border-bottom:1px solid #eee; white-space:nowrap; }
thead th { position:sticky; top:0; z-index:2; background:#e53935; color:white; font-weight:bold; text-transform:uppercase; cursor:pointer; }
tbody tr:nth-child(even){ background:#fbe9e7; }
tbody tr:nth-child(odd){ background:#fff; }
tbody tr:hover{ background:#ffccbc; }
#toggleSidebar { position:fixed; top:10px; left:10px; z-index:1100; background:#e53935; color:#fff; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; display:none; }
#spinner { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border:6px solid #f3f3f3; border-top:6px solid #e53935; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; z-index:1200; }
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.modal { display:none; position:fixed; z-index:1300; padding-top:50px; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); text-align:center; }
.modal .close { position:absolute; top:15px; right:25px; color:#fff; font-size:30px; cursor:pointer; }
.modal iframe { width:90%; height:80vh; border:none; border-radius:10px; }
.modal-actions { margin-top:15px; display:flex; justify-content:center; gap:10px; }
.modal-actions button { background:#e53935; color:#fff; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:bold; }
.modal-actions button:hover { background:#c62828; }
@media(max-width:768px){
  #sidebar{position:fixed; top:0; left:0; height:100vh; width:80vw; transform:translateX(-100%); transition:transform 0.3s ease; overflow-y:auto; -webkit-overflow-scrolling: touch; z-index:1000; background:#fbe9e7;}
  #sidebar.visible{transform:translateX(0);}
  #main{margin-left:0;}
  #toggleSidebar{display:block;}
}
</style>
</head>
<body>
<div id="spinner"></div>
<button id="toggleSidebar">☰</button>
<div id="sidebar">
<h2>Dossiers</h2>
<ul id="folderTree"></ul>
</div>
<div id="main">
<div class="header">
<img src="img/logo.png" class="logo" alt="Logo"/>
<div id="fileNameContainer">
<div id="fileName"></div>
<div id="lineCount"></div>
</div>
</div>
<div class="controls">
Filtrer par date : <input type="date" id="startDate"> à <input type="date" id="endDate">
<button onclick="applyFilter()">Filtrer</button>
<button onclick="clearFilter()">Tout afficher</button>
</div>
<div id="tableWrapper">
<div id="tableContainer">
<table id="csvTable">
<thead>
<tr>
<th>Date</th>
<th>Nom du fichier</th>
<th>Dossier</th>
<th>Taille</th>
<th>Télécharger / Ouvrir</th>
</tr>
</thead>
<tbody><tr><td colspan="5">Sélectionner un dossier...</td></tr></tbody>
</table>
</div>
</div>
</div>
<div id="imageModal" class="modal">
<span class="close" onclick="closeModal()">&times;</span>
<iframe id="modalFrame"></iframe>
<div class="modal-actions">
<button id="prevBtn">&larr; Précédent</button>
<button id="nextBtn">Suivant &rarr;</button>
<button id="downloadBtn">Télécharger</button>
</div>
</div>

<script>
const API_KEY='AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M';
const ROOT_FOLDER_ID='1BlX-uFXDADwAYRinFJJtscGOU557JZl3';
let imageFiles=[], currentImageIndex=0, filterStartDate='', filterEndDate='';

const sidebar=document.getElementById('sidebar');
const toggleBtn=document.getElementById('toggleSidebar');
const spinner=document.getElementById('spinner');
const csvTableBody=document.querySelector('#csvTable tbody');

toggleBtn.addEventListener('click',()=>{if(window.innerWidth<=768) sidebar.classList.toggle('visible');});
function showSpinner(){spinner.style.display='block';}
function hideSpinner(){spinner.style.display='none';}

async function fetchFolderContents(folderId){
  showSpinner();
  const res=await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false&key=${API_KEY}&fields=files(id,name,mimeType,size)`);
  const data=await res.json();
  hideSpinner();
  return data.files;
}

async function loadRootFolders(){
  const files=await fetchFolderContents(ROOT_FOLDER_ID);
  const rootUL=document.getElementById('folderTree');
  rootUL.innerHTML='';
  files.filter(f=>f.mimeType==='application/vnd.google-apps.folder').forEach(f=>{
    const li=document.createElement('li'); li.dataset.id=f.id;
    const toggle=document.createElement('span'); toggle.className='folder-toggle'; toggle.textContent='+'; toggle.onclick=()=>toggleFolder(li);
    const span=document.createElement('span'); span.className='folder-name'; span.textContent=f.name; 
    span.onclick=()=>loadFolderFilesOnClick(li);
    li.appendChild(toggle); li.appendChild(span); rootUL.appendChild(li);

    // Auto-ouvrir le dossier sauvegardé
    const savedId=localStorage.getItem('lastFolderId');
    if(savedId && savedId===f.id){ span.click(); }
  });

  // Charger les dates sauvegardées
  const savedStart=localStorage.getItem('filterStartDate');
  const savedEnd=localStorage.getItem('filterEndDate');
  if(savedStart){ document.getElementById('startDate').value=savedStart; filterStartDate=savedStart; }
  if(savedEnd){ document.getElementById('endDate').value=savedEnd; filterEndDate=savedEnd; }
}

async function toggleFolder(li){
  const toggle=li.querySelector('.folder-toggle');
  if(li.dataset.loaded==='true'){ 
    const ul=li.querySelector('ul'); 
    if(ul){ul.style.display=ul.style.display==='none'?'block':'none'; toggle.textContent=ul.style.display==='block'?'–':'+';} 
    return; 
  }
  toggle.textContent='…';
  const files=await fetchFolderContents(li.dataset.id);
  const ul=document.createElement('ul');
  files.filter(f=>f.mimeType==='application/vnd.google-apps.folder').forEach(f=>{
    const childLi=document.createElement('li'); childLi.dataset.id=f.id;
    const childToggle=document.createElement('span'); childToggle.className='folder-toggle'; childToggle.textContent='+'; childToggle.onclick=()=>toggleFolder(childLi);
    const span=document.createElement('span'); span.className='folder-name'; span.textContent=f.name; span.onclick=()=>loadFolderFilesOnClick(childLi);
    childLi.appendChild(childToggle); childLi.appendChild(span); ul.appendChild(childLi);
  });
  li.appendChild(ul); li.dataset.loaded='true'; toggle.textContent='+';
}

async function loadFolderFilesOnClick(li){
  await toggleFolder(li);
  document.querySelectorAll('#folderTree li span.folder-name').forEach(s=>s.classList.remove('active-folder'));
  li.querySelector('span.folder-name').classList.add('active-folder');
  
  // Sauvegarde du dossier sélectionné
  localStorage.setItem('lastFolderId', li.dataset.id);

  const files=await fetchFolderContents(li.dataset.id);
  const filteredFiles=files.filter(f=>f.name.toLowerCase().endsWith('.csv')||f.name.toLowerCase().endsWith('.jpg')||f.name.toLowerCase().endsWith('.jpeg'));
  imageFiles=filteredFiles.filter(f=>f.name.toLowerCase().endsWith('.jpg')||f.name.toLowerCase().endsWith('.jpeg'));
  displayFiles(filteredFiles, li.querySelector('span.folder-name').textContent);
}

function displayFiles(files, folderName){
  csvTableBody.innerHTML='';
  if(files.length===0){csvTableBody.innerHTML='<tr><td colspan="5">Aucun fichier</td></tr>'; return;}
  for(const f of files){
    const dateMatch=f.name.match(/(\d{8})\.csv$/);
    const date=dateMatch?`${dateMatch[1].slice(0,4)}-${dateMatch[1].slice(4,6)}-${dateMatch[1].slice(6,8)}`:'';
    if((filterStartDate&&date<filterStartDate)||(filterEndDate&&date>filterEndDate)) continue;
    const row=document.createElement('tr');
    const dateCell=document.createElement('td'); dateCell.textContent=date;
    const nameCell=document.createElement('td'); nameCell.textContent=f.name;
    const folderCell=document.createElement('td'); folderCell.textContent=folderName;
    const sizeCell=document.createElement('td'); sizeCell.textContent=f.size?Math.round(f.size/1024)+' Ko':'?';
    const actionCell=document.createElement('td');
    let actions=`<a href="https://drive.google.com/uc?export=download&id=${f.id}" target="_blank"><button>Télécharger</button></a>`;
    if(f.name.toLowerCase().endsWith('.csv')){
      actions+=`<button onclick="window.open('viewer.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}','_blank')">Tableau</button>`;
      actions+=`<button onclick="window.open('viewer02.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}','_blank')">Courbes</button>`;
    }
    if(f.name.toLowerCase().endsWith('.jpg')||f.name.toLowerCase().endsWith('.jpeg')){
      actions+=`<br><img src="https://drive.google.com/thumbnail?id=${f.id}" style="max-width:80px;cursor:pointer;border:1px solid #ccc;border-radius:5px" onclick="openModal('${f.id}')">`;
    }
    actionCell.innerHTML=actions;
    row.appendChild(dateCell); row.appendChild(nameCell); row.appendChild(folderCell); row.appendChild(sizeCell); row.appendChild(actionCell);
    csvTableBody.appendChild(row);
  }
}

// Filtrage
function applyFilter(){
  filterStartDate=document.getElementById('startDate').value;
  filterEndDate=document.getElementById('endDate').value;
  localStorage.setItem('filterStartDate', filterStartDate);
  localStorage.setItem('filterEndDate', filterEndDate);
  const active=document.querySelector('#folderTree .active-folder'); if(active) active.click();
}
function clearFilter(){
  filterStartDate=''; filterEndDate='';
  document.getElementById('startDate').value='';
  document.getElementById('endDate').value='';
  localStorage.removeItem('filterStartDate'); localStorage.removeItem('filterEndDate');
  const active=document.querySelector('#folderTree .active-folder'); if(active) active.click();
}

// Modal images
function openModal(id){const modal=document.getElementById('imageModal'); modal.style.display='block'; document.getElementById('modalFrame').src=`https://drive.google.com/file/d/${id}/preview`; currentImageIndex=imageFiles.findIndex(f=>f.id===id); document.getElementById('downloadBtn').onclick=()=>window.open(`https://drive.google.com/uc?export=download&id=${id}`,'_blank');}
function closeModal(){document.getElementById('imageModal').style.display='none';}
document.getElementById('prevBtn').onclick=()=>{if(currentImageIndex>0) openModal(imageFiles[--currentImageIndex].id);};
document.getElementById('nextBtn').onclick=()=>{if(currentImageIndex<imageFiles.length-1) openModal(imageFiles[++currentImageIndex].id);};
window.onclick=e=>{if(e.target===document.getElementById('imageModal')) closeModal();};

// Init
loadRootFolders();
</script>
</body>
</html>

