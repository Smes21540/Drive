<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Explorateur donn√©es s√©choirs</title>

<script src="libs/jszip.min.js"></script>
<script src="libs/FileSaver.min.js"></script>

<style>
:root{
  --bg:#fff5f5;
  --panel:#ffffff;
  --sidebar-bg:#ffe5d9;
  --text:#333;
  --muted-text:#555;
  --shadow:rgba(0,0,0,0.1);
  --overlay:rgba(0,0,0,0.8);
  --table-border:#eee;
  --thumb-border:#ccc;
  --accent:#ff7043;
  --accent-contrast:#fff;
  --accent-darker:#e64a19;
  --accent-muted:#ffccbc;
  --danger:#d84315;
  --row-even:#ffe5d9;
  --row-odd:#fff5f5;
}
body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0;display:flex;height:100vh;overflow:hidden;}
#netAlert{display:none;position:fixed;top:0;left:0;right:0;z-index:3000;background:var(--accent-muted);color:var(--danger);padding:8px;text-align:center;font-weight:bold;}
#sidebar{background:var(--sidebar-bg);border-right:2px solid var(--accent);padding:20px 10px;overflow-y:auto;z-index:1000;width:auto;min-width:200px;max-width:500px;}
#sidebar h2{color:var(--accent);font-size:18px;font-weight:bold;text-transform:uppercase;margin:0 0 12px 0;padding-left:5px;display:flex;align-items:center;gap:6px;}
#folderTree ul{list-style:none;padding-left:20px;margin:0;}
#folderTree li{cursor:pointer;margin:5px 0;}
.folder-toggle{font-weight:bold;margin-right:5px;cursor:pointer;color:var(--accent);}
.folder-name{cursor:pointer;}
.active-folder{background:var(--accent-muted);border-radius:3px;padding:2px 4px;}
#main{flex:1;padding:10px 20px;display:flex;flex-direction:column;overflow:hidden;}
.header{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:15px;}
.header .logo{height:60px;width:auto;}
#fileNameContainer{position:absolute;right:0;top:0;text-align:right;}
#fileName,#lineCount{color:var(--danger);}
#fileName{font-size:20px;font-weight:bold;white-space:nowrap;max-width:250px;overflow:hidden;text-overflow:ellipsis;display:none;}
#lineCount{font-size:12px;display:none;}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center;}
.controls button{background:var(--accent);color:var(--accent-contrast);border:none;cursor:pointer;font-weight:bold;padding:6px 12px;border-radius:6px;font-size:13px;transition:0.3s;}
.controls button:hover{background:var(--accent-darker);transform:scale(1.05);}
/* Champ date avec ic√¥ne */
.date-field{display:flex;align-items:center;gap:6px;background:var(--panel);border:2px solid var(--table-border);border-radius:6px;padding:4px 8px;}
.date-field span{font-size:16px;color:var(--accent);cursor:pointer;user-select:none;transition:0.2s;}
.date-field span:hover{transform:scale(1.2);}
.date-field input[type=date]{border:none;outline:none;background:transparent;font-size:14px;color:var(--text);padding:6px 2px;}
/* Supprimer l‚Äôic√¥ne native calendrier */
input[type="date"]::-webkit-calendar-picker-indicator{display:none;-webkit-appearance:none;}
input[type="date"]::-moz-focus-inner{border:0;}
/* Effet halo orange quand focus */
.date-field input[type=date]:focus {
  box-shadow: 0 0 6px var(--accent);
  border-color: var(--accent);
  color: var(--danger);
}
#tableWrapper{flex:1;overflow:auto;}
#tableContainer{overflow:auto;border-radius:8px;box-shadow:0 4px 12px var(--shadow);background:var(--panel);}
table{border-collapse:separate;border-spacing:0;width:100%;font-size:13px;}
thead th,tbody td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--table-border);white-space:nowrap;}
thead th{position:sticky;top:0;z-index:2;background:var(--accent);color:var(--accent-contrast);font-weight:bold;text-transform:uppercase;cursor:pointer;}
tbody tr:nth-child(even){background:var(--row-even);}
tbody tr:nth-child(odd){background:var(--row-odd);}
tbody tr:hover{background:var(--accent-muted);}
#toggleSidebar{position:fixed;top:10px;left:10px;z-index:1100;background:var(--accent);color:var(--accent-contrast);border:none;padding:5px 10px;border-radius:5px;cursor:pointer;display:none;}
#spinner{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;}
.modal{display:none;position:fixed;z-index:1300;padding-top:50px;left:0;top:0;width:100%;height:100%;background-color:var(--overlay);text-align:center;}
.modal .close{position:absolute;top:15px;right:25px;color:#fff;font-size:30px;cursor:pointer;}
.modal iframe{width:90%;height:80vh;border:none;border-radius:10px;}
.modal-actions{margin-top:15px;display:flex;justify-content:center;gap:10px;}
.modal-actions button{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;font-weight:bold;}
.modal-actions button:hover{background:var(--accent-darker);}
@media(max-width:768px){
  #sidebar{position:fixed;top:0;left:0;height:100vh;width:80vw;transform:translateX(-100%);transition:transform 0.3s ease;}
  #sidebar.visible{transform:translateX(0);}
  #toggleSidebar{display:block;}
}
/* Overlay ZIP */
#zipOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:1400;justify-content:center;align-items:center;}
#zipBox{background:var(--accent-muted);color:var(--text);padding:20px 25px;border-radius:12px;text-align:center;width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.3);position:relative;}
#zipBox h2{margin:0 0 10px 0;color:var(--accent);font-size:18px;}
#zipFileName{font-size:13px;margin-bottom:15px;color:var(--muted-text);word-break:break-word;}
#zipProgressBar{width:100%;height:22px;background:#eee;border-radius:11px;overflow:hidden;}
#zipProgress{height:100%;width:0;background:var(--accent);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:13px;}
#zipCounter{margin-top:10px;font-size:12px;color:var(--text);}
#zipTime{margin-top:5px;font-size:12px;color:var(--muted-text);}
#zipClose{position:absolute;top:8px;right:12px;font-size:18px;font-weight:bold;color:var(--accent);cursor:pointer;}
#zipClose:hover{color:var(--accent-darker);}
.sort-arrow{margin-left:5px;font-size:11px;color:var(--accent-contrast);}
/* Miniatures JPG */
#csvTable td img{max-width:120px;cursor:pointer;border-radius:6px;transition:transform 0.2s,box-shadow 0.2s;}
#csvTable td img:hover{transform:scale(1.1);box-shadow:0 0 8px var(--shadow);}
/* Cellule actions */
td.action-cell{display:flex;align-items:center;gap:8px;}
/* Boutons du tableau */
.action-btn{background:var(--accent);color:var(--accent-contrast);border:none;cursor:pointer;font-weight:bold;padding:6px 12px;border-radius:6px;font-size:12px;transition:0.2s;margin-right:6px;opacity:0;visibility:hidden;}
tbody tr:hover .action-btn{opacity:1;visibility:visible;}
.action-btn:hover{background:var(--accent-darker);transform:scale(1.05);}
</style>
</head>
<body>

<div id="netAlert">‚ö†Ô∏è Pas de connexion internet d√©tect√©e. V√©rifiez votre r√©seau.</div>
<div id="spinner"></div>
<button id="toggleSidebar">‚ò∞</button>

<div id="sidebar">
<h2><span>üìÅ</span>Dossiers</h2>
<ul id="folderTree"></ul>
</div>

<div id="main">
<div class="header">
<img src="img/logo.png" class="logo" alt="Logo"/>
<div id="fileNameContainer">
<div id="fileName"></div>
<div id="lineCount"></div>
</div>
</div>
<div class="controls">
  Filtrer par date : 
  <div class="date-field"><span id="iconStart">üìÖ</span><input type="date" id="startDate"></div>
  √†
  <div class="date-field"><span id="iconEnd">üìÖ</span><input type="date" id="endDate"></div>
  <button onclick="applyFilter()">Filtrer</button>
  <button onclick="clearFilter()">Tout afficher</button>
  <button id="downloadFolderBtn">T√©l√©charger le dossier</button>
</div>

<div id="tableWrapper">
<div id="tableContainer">
<table id="csvTable">
<thead>
<tr>
<th onclick="sortTable(0,'date')">Date <span class="sort-arrow"></span></th>
<th>Nom du fichier</th>
<th>Dossier</th>
<th onclick="sortTable(3,'number')">Taille <span class="sort-arrow"></span></th>
<th>T√©l√©charger / Ouvrir</th>
</tr>
</thead>
<tbody><tr><td colspan="5">S√©lectionner un dossier...</td></tr></tbody>
</table>
</div>
</div>
</div>

<div id="imageModal" class="modal">
<span class="close" onclick="closeModal()">&times;</span>
<iframe id="modalFrame"></iframe>
<div class="modal-actions">
<button id="prevBtn">&larr; Pr√©c√©dent</button>
<button id="nextBtn">Suivant &rarr;</button>
<button id="downloadBtn">T√©l√©charger</button>
</div>
</div>

<div id="zipOverlay">
<div id="zipBox">
<span id="zipClose">&times;</span>
<h2>Pr√©paration du ZIP...</h2>
<div id="zipFileName"></div>
<div id="zipProgressBar"><div id="zipProgress">0%</div></div>
<div id="zipCounter">0 / 0 fichiers</div>
<div id="zipTime">Temps restant : --</div>
</div>
</div>

<script>
const API_KEY="AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M";
const ROOT_FOLDER_ID="1BlX-uFXDADwAYRinFJJtscGOU557JZl3";
let imageFiles=[],currentImageIndex=0,filterStartDate="",filterEndDate="";
const csvTableBody=document.querySelector("#csvTable tbody");

function updateNetworkStatus(){document.getElementById("netAlert").style.display=navigator.onLine?"none":"block";}
window.addEventListener("online",updateNetworkStatus);
window.addEventListener("offline",updateNetworkStatus);

function showSpinner(){spinner.style.display="block";}
function hideSpinner(){spinner.style.display="none";}

async function fetchFolderContents(folderId){
  showSpinner();
  try{
    const res=await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false&key=${API_KEY}&fields=files(id,name,mimeType,size,createdTime,modifiedTime)`);
    const data=await res.json();
    return data.files||[];
  }catch(err){console.error("Erreur Drive:",err);return [];}finally{hideSpinner();}
}
async function loadRootFolders(){
  const files=await fetchFolderContents(ROOT_FOLDER_ID);
  const rootUL=document.getElementById("folderTree");
  rootUL.innerHTML="";
  files.filter(f=>f.mimeType==="application/vnd.google-apps.folder").forEach(f=>{
    const li=document.createElement("li");li.dataset.id=f.id;
    const toggle=document.createElement("span");toggle.className="folder-toggle";toggle.textContent="+";toggle.onclick=()=>toggleFolder(li);
    const span=document.createElement("span");span.className="folder-name";span.textContent=f.name;span.onclick=()=>loadFolderFilesOnClick(li);
    li.appendChild(toggle);li.appendChild(span);rootUL.appendChild(li);
  });
}
async function toggleFolder(li){
  const toggle=li.querySelector(".folder-toggle");
  if(li.dataset.loaded==="true"){const ul=li.querySelector("ul");if(ul){ul.style.display=ul.style.display==="none"?"block":"none";toggle.textContent=ul.style.display==="block"?"‚Äì":"+";}return;}
  toggle.textContent="‚Ä¶";const files=await fetchFolderContents(li.dataset.id);const ul=document.createElement("ul");
  files.filter(f=>f.mimeType==="application/vnd.google-apps.folder").forEach(f=>{
    const childLi=document.createElement("li");childLi.dataset.id=f.id;
    const childToggle=document.createElement("span");childToggle.className="folder-toggle";childToggle.textContent="+";childToggle.onclick=()=>toggleFolder(childLi);
    const span=document.createElement("span");span.className="folder-name";span.textContent=f.name;span.onclick=()=>loadFolderFilesOnClick(childLi);
    childLi.appendChild(childToggle);childLi.appendChild(span);ul.appendChild(childLi);
  });li.appendChild(ul);li.dataset.loaded="true";toggle.textContent="+";
}
async function loadFolderFilesOnClick(li){
  await toggleFolder(li);document.querySelectorAll("#folderTree li span.folder-name").forEach(s=>s.classList.remove("active-folder"));
  li.querySelector("span.folder-name").classList.add("active-folder");localStorage.setItem("lastFolderId",li.dataset.id);
  const files=await fetchFolderContents(li.dataset.id);
  const filtered=files.filter(f=>f.name.toLowerCase().endsWith(".csv")||f.name.toLowerCase().endsWith(".jpg")||f.name.toLowerCase().endsWith(".jpeg"));
  imageFiles=filtered.filter(f=>f.name.toLowerCase().endsWith(".jpg")||f.name.toLowerCase().endsWith(".jpeg"));
  displayFiles(filtered,li.querySelector("span.folder-name").textContent);
}
function displayFiles(files,folderName){
  csvTableBody.innerHTML="";if(files.length===0){csvTableBody.innerHTML="<tr><td colspan='5'>Aucun fichier</td></tr>";return;}
  for(const f of files){
    let date="";const match=f.name.match(/(\d{8})\.csv$/i);
    if(match){date=`${match[1].slice(0,4)}-${match[1].slice(4,6)}-${match[1].slice(6,8)}`;}
    else if(/\.(jpg|jpeg)$/i.test(f.name)){if(f.modifiedTime)date=f.modifiedTime.slice(0,10);else if(f.createdTime)date=f.createdTime.slice(0,10);}
    if((filterStartDate&&date<filterStartDate)||(filterEndDate&&date>filterEndDate))continue;
    const row=document.createElement("tr");
    const dateCell=document.createElement("td");dateCell.textContent=date;
    const nameCell=document.createElement("td");nameCell.textContent=f.name;
    const folderCell=document.createElement("td");folderCell.textContent=folderName;
    const sizeCell=document.createElement("td");sizeCell.textContent=f.size?Math.round(f.size/1024)+" Ko":"?";
    const actionCell=document.createElement("td");actionCell.className="action-cell";
    let actions="";
    if(f.name.toLowerCase().endsWith(".csv")){
      actions+=`<a href="https://drive.google.com/uc?export=download&id=${f.id}" target="_blank"><button class="action-btn">T√©l√©charger</button></a>`;
      actions+=`<button class="action-btn" onclick="window.open('viewer.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}','_blank')">Tableau</button>`;
      actions+=`<button class="action-btn" onclick="window.open('viewer02.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}','_blank')">Courbes</button>`;
    }
    if(/\.(jpg|jpeg)$/i.test(f.name)){
      actions+=`<img src="https://drive.google.com/thumbnail?id=${f.id}" onclick="openModal('${f.id}')">`;
      actions+=`<a href="https://drive.google.com/uc?export=download&id=${f.id}" target="_blank"><button class="action-btn">T√©l√©charger</button></a>`;
    }
    actionCell.innerHTML=actions;row.appendChild(dateCell);row.appendChild(nameCell);row.appendChild(folderCell);row.appendChild(sizeCell);row.appendChild(actionCell);csvTableBody.appendChild(row);
  }
}
function applyFilter(){filterStartDate=document.getElementById("startDate").value;filterEndDate=document.getElementById("endDate").value;const active=document.querySelector("#folderTree .active-folder");if(active)active.click();}
function clearFilter(){filterStartDate="";filterEndDate="";document.getElementById("startDate").value="";document.getElementById("endDate").value="";const active=document.querySelector("#folderTree .active-folder");if(active)active.click();}
function openModal(id){const modal=document.getElementById("imageModal");modal.style.display="block";document.getElementById("modalFrame").src=`https://drive.google.com/file/d/${id}/preview`;currentImageIndex=imageFiles.findIndex(f=>f.id===id);document.getElementById("downloadBtn").onclick=()=>window.open(`https://drive.google.com/uc?export=download&id=${id}`,"_blank");}
function closeModal(){document.getElementById("imageModal").style.display="none";}
document.getElementById("prevBtn").onclick=()=>{if(currentImageIndex>0)openModal(imageFiles[--currentImageIndex].id);};
document.getElementById("nextBtn").onclick=()=>{if(currentImageIndex<imageFiles.length-1)openModal(imageFiles[++currentImageIndex].id);};
window.onclick=e=>{if(e.target===document.getElementById("imageModal"))closeModal();};
const zipOverlay=document.getElementById("zipOverlay"),zipProgress=document.getElementById("zipProgress"),zipCounter=document.getElementById("zipCounter"),zipFileName=document.getElementById("zipFileName"),zipTime=document.getElementById("zipTime"),zipClose=document.getElementById("zipClose");let zipCancelled=false,zipStartTime=0;
function showZipOverlay(name){zipCancelled=false;zipOverlay.style.display="flex";zipFileName.textContent=name;zipProgress.style.width="0%";zipProgress.textContent="0%";zipCounter.textContent="0 / 0 fichiers";zipTime.textContent="Temps restant : --";zipStartTime=Date.now();}
function hideZipOverlay(){zipOverlay.style.display="none";}
function updateZipProgress(pct,current,total,sizeAccum){zipProgress.style.width=pct+"%";zipProgress.textContent=pct+"%";zipCounter.textContent=`${current} / ${total} fichiers`;if(current>0){const elapsed=(Date.now()-zipStartTime)/1000;const speedFiles=current/elapsed;const speedKB=(sizeAccum/1024)/elapsed;const remainingFiles=total-current;const remainingTime=remainingFiles/speedFiles;const mins=Math.floor(remainingTime/60);const secs=Math.round(remainingTime%60);zipTime.textContent=`Temps restant : ${mins>0?mins+"m ":''}${secs}s (${speedFiles.toFixed(1)} fichiers/s, ${speedKB.toFixed(0)} Ko/s)`;}}
zipClose.onclick=()=>{zipCancelled=true;hideZipOverlay();alert("Pr√©paration ZIP annul√©e.");};
document.getElementById("downloadFolderBtn").onclick=async()=>{const active=document.querySelector("#folderTree .active-folder");if(!active){alert("S√©lectionnez un dossier !");return;}const folderId=localStorage.getItem("lastFolderId");const folderName=active.textContent.trim();showZipOverlay(folderName+".zip");const files=await fetchFolderContents(folderId);if(!files||files.length===0){hideZipOverlay();alert("Aucun fichier dans ce dossier.");return;}const zip=new JSZip();let count=0;let doneSize=0;for(const f of files){if(zipCancelled)return;try{const url=`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`;const res=await fetch(url);const blob=await res.blob();zip.file(f.name,blob);count++;doneSize+=f.size?parseInt(f.size):0;updateZipProgress(Math.round((count/files.length)*100),count,files.length,doneSize);}catch(e){console.error("Erreur sur",f.name,e);}}if(zipCancelled)return;const content=await zip.generateAsync({type:"blob"});saveAs(content,folderName+".zip");hideZipOverlay();};
let currentSort={col:null,asc:true};
function sortTable(colIndex,type){const table=document.getElementById("csvTable");const tbody=table.tBodies[0];const rows=Array.from(tbody.querySelectorAll("tr"));if(currentSort.col===colIndex){currentSort.asc=!currentSort.asc;}else{currentSort.col=colIndex;currentSort.asc=true;}rows.sort((a,b)=>{let aText=a.cells[colIndex]?.textContent.trim()||"";let bText=b.cells[colIndex]?.textContent.trim()||"";if(type==="number"){aText=parseInt(aText)||0;bText=parseInt(bText)||0;}else if(type==="date"){aText=new Date(aText).getTime()||0;bText=new Date(bText).getTime()||0;}if(aText<bText)return currentSort.asc?-1:1;if(aText>bText)return currentSort.asc?1:-1;return 0;});tbody.innerHTML="";rows.forEach(r=>tbody.appendChild(r));document.querySelectorAll("th .sort-arrow").forEach(el=>el.textContent="");const arrow=table.tHead.rows[0].cells[colIndex].querySelector(".sort-arrow");if(arrow){arrow.textContent=currentSort.asc?"‚Üë":"‚Üì";}}
/* Ic√¥nes calendrier cliquables */
document.getElementById("iconStart").onclick=()=>document.getElementById("startDate").showPicker?.()||document.getElementById("startDate").focus();
document.getElementById("iconEnd").onclick=()=>document.getElementById("endDate").showPicker?.()||document.getElementById("endDate").focus();
window.onload=()=>{updateNetworkStatus();loadRootFolders();const last=localStorage.getItem("lastFolderId");if(last){const temp={dataset:{id:last},querySelector:()=>({classList:{add:()=>{}}})};loadFolderFilesOnClick(temp);}};
</script>
</body>
</html>











