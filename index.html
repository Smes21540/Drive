<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SMES CSV Explorateur</title>
<style>
body { font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color:#fff8f5; margin:0; padding:0; color:#333; font-size:14px; display:flex; height:100vh; overflow:hidden;}
#sidebar { width:300px; background-color:#fbe9e7; border-right:2px solid #e53935; padding:20px 10px; overflow-y:auto; transition: width 0.3s ease, display 0.3s ease; }
#folderTree ul { list-style:none; padding-left:20px; margin:0; }
#folderTree li { cursor:pointer; margin:5px 0; }
.folder-toggle { font-weight:bold; margin-right:5px; cursor:pointer; color:#e53935; }
.folder-name { cursor:pointer; }
.active-folder { background-color:#ffccbc; border-radius:3px; padding:2px 4px; }
#main { flex:1; padding:10px 20px; display:flex; flex-direction:column; overflow:hidden; }
.header { display:flex; align-items:center; justify-content:center; position:relative; margin-bottom:15px; }
.header .logo { height:60px; width:auto; }
#fileNameContainer { position:absolute; right:0; top:0; text-align:right; }
#fileName,#lineCount{ color:#800000; }
#fileName{ font-size:20px; font-weight:bold; white-space:nowrap; max-width:250px; overflow:hidden; text-overflow:ellipsis; display:none; }
#lineCount{ font-size:12px; display:none; }
.controls { display:flex; flex-wrap:wrap; justify-content:flex-start; gap:10px; margin-bottom:10px; }
.controls button{ background-color:#e53935; color:white; border:none; cursor:pointer; font-weight:bold; padding:6px 12px; border-radius:6px; font-size:13px; transition:background-color 0.3s ease, transform 0.2s ease; }
.controls button:hover{ background-color:#c62828; transform:scale(1.05); }
.controls input[type=date]{ padding:5px; }
#tableWrapper { flex:1; overflow:auto; }
#tableContainer { overflow:auto; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); background:white; }
table { border-collapse:separate; border-spacing:0; width:100%; font-size:13px; table-layout:auto; }
thead th, tbody td { padding:10px 12px; text-align:left; border-bottom:1px solid #eee; white-space:nowrap; }
thead th { position:sticky; top:0; z-index:2; background-color:#e53935; color:white; font-weight:bold; text-transform:uppercase; cursor:pointer; }
tbody tr:nth-child(even){ background-color:#fbe9e7; }
tbody tr:nth-child(odd){ background-color:#ffffff; }
tbody tr:hover{ background-color:#ffccbc; }
#spinner { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border:6px solid #f3f3f3; border-top:6px solid #e53935; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; z-index:1000; }
@keyframes spin { 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }
.modal { display:none; position:fixed; z-index:999; padding-top:50px; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); text-align:center; }
.modal .close { position:absolute; top:15px; right:25px; color:#fff; font-size:30px; cursor:pointer; }
.modal iframe { width:90%; height:80vh; border:none; border-radius:10px; }
.modal-actions { margin-top:15px; display:flex; justify-content:center; gap:10px; }
.modal-actions button { background:#e53935; color:#fff; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:bold; }
.modal-actions button:hover { background:#c62828; }
/* --- Responsive mobile --- */
@media (max-width: 768px) {
  body { flex-direction: column; height: auto; }
  #sidebar { width: 100%; max-height: 150px; overflow-y: auto; overflow-x:auto; border-right:none; border-bottom:2px solid #e53935; }
  #main { padding:10px; }
  .header { flex-direction: column; }
  .header .logo { height:50px; margin-bottom:10px; }
  .controls { flex-direction: column; gap:5px; }
  .controls button { width:100%; }
  #tableContainer { overflow-x:auto; }
  table { font-size:12px; }
  #tableContainer table thead th, #tableContainer table tbody td { padding:6px 8px; }
}
</style>
</head>
<body>
<div id="spinner"></div>

<div id="sidebar">
<button id="toggleSidebar" style="background:#e53935;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;margin-bottom:10px;">☰</button>
<h2>Dossiers</h2>
<ul id="folderTree">
<li data-id="1BlX-uFXDADwAYRinFJJtscGOU557JZl3">
<span class="folder-toggle">+</span> <span class="folder-name">Tous les dossiers</span>
</li>
</ul>
</div>

<div id="main">
<div class="header">
<img src="img/logo.png" alt="Logo SMES France" class="logo" />
<div id="fileNameContainer">
<div id="fileName"></div>
<div id="lineCount"></div>
</div>
</div>

<div class="controls">
Filtrer par date : <input type="date" id="startDate"> à <input type="date" id="endDate">
<button onclick="applyFilter()">Filtrer</button>
<button onclick="clearFilter()">Tout afficher</button>
</div>

<div id="tableWrapper">
<div id="tableContainer">
<table id="csvTable">
<thead>
<tr>
<th>Date</th>
<th>Nom du fichier</th>
<th>Dossier</th>
<th>Taille</th>
<th>Télécharger / Ouvrir</th>
</tr>
</thead>
<tbody>
<tr><td colspan="5">Sélectionner un dossier pour afficher les fichiers...</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="imageModal" class="modal">
<span class="close" onclick="closeModal()">&times;</span>
<iframe id="modalFrame"></iframe>
<div class="modal-actions">
<button id="prevBtn">&larr; Précédent</button>
<button id="nextBtn">Suivant &rarr;</button>
<button id="downloadBtn">Télécharger</button>
</div>
</div>

<script>
const spinner=document.getElementById('spinner');
const sidebar=document.getElementById('sidebar');
const toggleBtn=document.getElementById('toggleSidebar');
toggleBtn.addEventListener('click', ()=>{
    if(sidebar.style.width==='0px' || sidebar.style.display==='none'){
        sidebar.style.display='block'; sidebar.style.width='300px';
    } else { sidebar.style.width='0'; sidebar.style.display='none'; }
});

let imageFiles=[]; let currentImageIndex=0; let sortOrder='desc'; let filterStartDate=''; let filterEndDate='';

function showSpinner(){spinner.style.display='block';} 
function hideSpinner(){spinner.style.display='none';}

async function fetchFolderContents(folderId){
    showSpinner();
    const res=await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false&key=AIzaSyCbEV3CS9bOcxq5eK-QXbjczGHjvzyXS6M&fields=files(id,name,mimeType,size)`);
    const data=await res.json();
    hideSpinner();
    return data.files;
}

async function toggleFolder(li){
    const toggle=li.querySelector('.folder-toggle');
    if(li.dataset.loaded==='true'){
        const ul=li.querySelector('ul');
        if(ul){ ul.style.display=ul.style.display==='none'?'block':'none'; toggle.textContent=ul.style.display==='block'?'–':'+'; }
        return;
    }
    toggle.textContent='…';
    const files=await fetchFolderContents(li.dataset.id);
    const ul=document.createElement('ul');
    files.filter(f=>f.mimeType==='application/vnd.google-apps.folder').forEach(f=>{
        const childLi=document.createElement('li'); childLi.dataset.id=f.id;
        const childToggle=document.createElement('span'); childToggle.className='folder-toggle'; childToggle.textContent='+'; childToggle.onclick=()=>toggleFolder(childLi);
        const spanName=document.createElement('span'); spanName.className='folder-name'; spanName.textContent=f.name; spanName.onclick=()=>loadFolderFilesOnClick(childLi);
        childLi.appendChild(childToggle); childLi.appendChild(spanName); ul.appendChild(childLi);
    });
    li.appendChild(ul); li.dataset.loaded='true'; toggle.textContent='–';
}

async function loadFolderFilesOnClick(li){
    await toggleFolder(li);
    document.querySelectorAll('#folderTree li span.folder-name').forEach(s=>s.classList.remove('active-folder'));
    li.querySelector('span.folder-name').classList.add('active-folder');

    const files=await fetchFolderContents(li.dataset.id);
    const filteredFiles=files.filter(f=>f.name.toLowerCase().endsWith('.csv') || f.name.toLowerCase().endsWith('.jpg') || f.name.toLowerCase().endsWith('.jpeg'));
    imageFiles=filteredFiles.filter(f=>f.name.toLowerCase().endsWith('.jpg') || f.name.toLowerCase().endsWith('.jpeg'));
    displayFiles(filteredFiles, li.querySelector('span.folder-name').textContent);
}

function displayFiles(files, folderName){
    const tbody=document.querySelector('#csvTable tbody'); tbody.innerHTML='';
    if(files.length===0){ tbody.innerHTML='<tr><td colspan="5">Aucun fichier dans ce dossier</td></tr>'; return; }
    for(const f of files){
        const row=document.createElement('tr');
        let dateMatch=f.name.match(/(\d{8})\.csv$/);
        let date=dateMatch?`${dateMatch[1].slice(0,4)}-${dateMatch[1].slice(4,6)}-${dateMatch[1].slice(6,8)}`:'';
        if((filterStartDate&&date<filterStartDate)||(filterEndDate&&date>filterEndDate)) continue;

        const dateCell=document.createElement('td'); dateCell.textContent=date;
        const nameCell=document.createElement('td'); nameCell.textContent=f.name;
        const folderCell=document.createElement('td'); folderCell.textContent=folderName;

        const sizeCell=document.createElement('td'); 
        if(f.size){ let sizeKo=f.size/1024; sizeCell.textContent=sizeKo<1024?sizeKo.toFixed(1)+' Ko':(sizeKo/1024).toFixed(1)+' Mo'; } else sizeCell.textContent='-';

        let actions=`<a href='https://drive.google.com/uc?export=download&id=${f.id}' target='_blank'><button>Télécharger</button></a>`;
        if(f.name.toLowerCase().endsWith('.csv')){
            actions+=` <button onclick="window.open('viewer.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}','_blank')">Tableau</button>
                       <button onclick="window.open('viewer02.html?fileId=${f.id}&fileName=${encodeURIComponent(f.name)}','_blank')">Courbes</button>`;
        }
        if(f.name.toLowerCase().endsWith('.jpg')||f.name.toLowerCase().endsWith('.jpeg')){
            actions+=`<br><img src='https://drive.google.com/thumbnail?id=${f.id}' style='max-width:80px;cursor:pointer;margin-top:5px;border:1px solid #ccc;border-radius:4px' onclick='openModal(${imageFiles.findIndex(im=>im.id===f.id)})'>`;
        }
        const actionCell=document.createElement('td'); actionCell.innerHTML=actions;
        row.appendChild(dateCell); row.appendChild(nameCell); row.appendChild(folderCell); row.appendChild(sizeCell); row.appendChild(actionCell);
        tbody.appendChild(row);
    }
    sortTableByDate();
}

function sortTableByDate(){
    const tbody=document.querySelector('#csvTable tbody');
    const rows=Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a,b)=>{
        const da=a.children[0].textContent; const db=b.children[0].textContent;
        return sortOrder==='asc'?da.localeCompare(db):db.localeCompare(da);
    });
    rows.forEach(r=>tbody.appendChild(r));
}

document.querySelector('#csvTable thead th:first-child').addEventListener('click',()=>{
    sortOrder=sortOrder==='asc'?'desc':'asc'; sortTableByDate();
});

function openModal(index){ currentImageIndex=index; document.getElementById('modalFrame').src=`https://drive.google.com/file/d/${imageFiles[currentImageIndex].id}/preview`; document.getElementById('downloadBtn').onclick=()=>window.open(`https://drive.google.com/uc?export=download&id=${imageFiles[currentImageIndex].id}`,'_blank'); document.getElementById('imageModal').style.display='block'; }
function closeModal(){ document.getElementById('imageModal').style.display='none'; document.getElementById('modalFrame').src=''; }
document.getElementById('prevBtn').onclick=()=>{ if(currentImageIndex>0) openModal(currentImageIndex-1); };
document.getElementById('nextBtn').onclick=()=>{ if(currentImageIndex<imageFiles.length-1) openModal(currentImageIndex+1); };
document.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft'){ if(currentImageIndex>0) openModal(currentImageIndex-1); } else if(e.key==='ArrowRight'){ if(currentImageIndex<imageFiles.length-1) openModal(currentImageIndex+1); } });

function applyFilter(){ filterStartDate=document.getElementById('startDate').value; filterEndDate=document.getElementById('endDate').value; const activeLi=document.querySelector('#folderTree li span.folder-name.active-folder').parentElement; loadFolderFilesOnClick(activeLi); }
function clearFilter(){ document.getElementById('startDate').value=''; document.getElementById('endDate').value=''; filterStartDate=''; filterEndDate=''; const activeLi=document.querySelector('#folderTree li span.folder-name.active-folder').parentElement; loadFolderFilesOnClick(activeLi); }

const rootLi=document.querySelector('#folderTree li');
toggleFolder(rootLi).then(()=>{
    const firstSubLi=rootLi.querySelector('ul li');
    if(firstSubLi){ firstSubLi.querySelector('span.folder-name').classList.add('active-folder'); loadFolderFilesOnClick(firstSubLi); }
});
rootLi.querySelector('span.folder-name').onclick=()=>loadFolderFilesOnClick(rootLi);
</script>
</body>
</html>
